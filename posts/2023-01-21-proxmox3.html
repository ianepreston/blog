<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-01-21">
<meta name="description" content="Homelab cluster adventures continue">

<title>Home cluster part 3 - Setup VM templates on proxmox – Ian’s blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-659650fc26dc25888fc1474f317bb8ac.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ian’s blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ianepreston"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Home cluster part 3 - Setup VM templates on proxmox</h1>
                  <div>
        <div class="description">
          Homelab cluster adventures continue
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">configuration</div>
                <div class="quarto-category">linux</div>
                <div class="quarto-category">proxmox</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 21, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#basic-menu-driven-install" id="toc-basic-menu-driven-install" class="nav-link" data-scroll-target="#basic-menu-driven-install">Basic menu driven install</a>
  <ul class="collapse">
  <li><a href="#create-the-vm" id="toc-create-the-vm" class="nav-link" data-scroll-target="#create-the-vm">Create the VM</a></li>
  <li><a href="#configure-the-vm" id="toc-configure-the-vm" class="nav-link" data-scroll-target="#configure-the-vm">Configure the VM</a></li>
  </ul></li>
  <li><a href="#create-a-template-image" id="toc-create-a-template-image" class="nav-link" data-scroll-target="#create-a-template-image">Create a template image</a>
  <ul class="collapse">
  <li><a href="#thoughts-on-manual-templates" id="toc-thoughts-on-manual-templates" class="nav-link" data-scroll-target="#thoughts-on-manual-templates">Thoughts on manual templates</a></li>
  <li><a href="#cleaning-up" id="toc-cleaning-up" class="nav-link" data-scroll-target="#cleaning-up">Cleaning up</a></li>
  </ul></li>
  <li><a href="#automate-creating-a-template" id="toc-automate-creating-a-template" class="nav-link" data-scroll-target="#automate-creating-a-template">Automate creating a template</a>
  <ul class="collapse">
  <li><a href="#automate-creating-another-template" id="toc-automate-creating-another-template" class="nav-link" data-scroll-target="#automate-creating-another-template">Automate creating another template</a></li>
  <li><a href="#examine-the-template-creation-script-and-modify-it" id="toc-examine-the-template-creation-script-and-modify-it" class="nav-link" data-scroll-target="#examine-the-template-creation-script-and-modify-it">Examine the template creation script and modify it</a></li>
  <li><a href="#get-back-to-making-rocky-linux-work-spoiler-i-do-not-succeed" id="toc-get-back-to-making-rocky-linux-work-spoiler-i-do-not-succeed" class="nav-link" data-scroll-target="#get-back-to-making-rocky-linux-work-spoiler-i-do-not-succeed">Get back to making Rocky Linux work (spoiler, I do not succeed)</a></li>
  <li><a href="#try-arch-linux" id="toc-try-arch-linux" class="nav-link" data-scroll-target="#try-arch-linux">Try Arch Linux</a></li>
  <li><a href="#try-flatcar-linux" id="toc-try-flatcar-linux" class="nav-link" data-scroll-target="#try-flatcar-linux">Try flatcar Linux</a></li>
  </ul></li>
  <li><a href="#automate-deploying-vms-from-templates" id="toc-automate-deploying-vms-from-templates" class="nav-link" data-scroll-target="#automate-deploying-vms-from-templates">Automate deploying VMs from templates</a></li>
  <li><a href="#automate-creating-templates-across-nodes" id="toc-automate-creating-templates-across-nodes" class="nav-link" data-scroll-target="#automate-creating-templates-across-nodes">Automate creating templates across nodes</a></li>
  <li><a href="#automate-scheduled-rebuilds-of-the-templates" id="toc-automate-scheduled-rebuilds-of-the-templates" class="nav-link" data-scroll-target="#automate-scheduled-rebuilds-of-the-templates">Automate scheduled rebuilds of the templates</a></li>
  <li><a href="#conclusion-and-next-steps" id="toc-conclusion-and-next-steps" class="nav-link" data-scroll-target="#conclusion-and-next-steps">Conclusion and next steps</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This is the third post ( <a href="../posts/2022-11-21-proxmox.html">part 1</a>, <a href="../posts/2022-12-31-proxmox2.html">part 2</a>) documenting my adventures setting up a home cluster. In this one I will try a few different methods of getting VMs installed on proxmox. As with the previous posts, this is not intended to be a how to guide from an expert. I haven’t used proxmox before working on this project, so I’m mostly doing this to document what I do for future reference, or maybe provide others with the perspective of what it’s like to work on proxmox as a relative beginner.</p>
<p>All the code I reference in this post is in my <a href="https://github.com/ianepreston/recipes">recipes</a> repository. Specifically, the ansible role to create templates is <a href="https://github.com/ianepreston/recipes/tree/master/ansible/roles/pve_templates">here</a> and the terraform code is <a href="https://github.com/ianepreston/recipes/tree/master/terraform/pve">here</a></p>
</section>
<section id="basic-menu-driven-install" class="level1">
<h1>Basic menu driven install</h1>
<section id="create-the-vm" class="level2">
<h2 class="anchored" data-anchor-id="create-the-vm">Create the VM</h2>
<p>The most obvious way to install a VM is through the UI. I know I won’t want to take this approach indefinitely as it involves manual work and isn’t reproducible (at least not easily), but it seems like the right place to start, both to ensure I don’t have any unforeseen issues with my setup, and also to provide a baseline for comparison when I try other methods later.</p>
<p>Selecting one of my nodes from the web interface I click “Create VM”. In the first tab I pick the node to install to and give it a name, we’ll do <code>ubuntu-test</code> for this. I could also assign it to a <a href="https://pve.proxmox.com/wiki/User_Management#pveum_resource_pools">resource pool</a> if I had any of those created but I don’t so I won’t. The other thing I can assign is a VM ID, which is the unique numeric identifier proxmox uses internally. At this point I’m fine to let proxmox manage that though so I’ll leave it on the default.</p>
<p>Checking the advanced options I can also configure the VM to start at boot so it will come back up if I reboot my cluster. I can also configure the order it starts/stops. The start at boot setting seems like it would be handy for production services, but I’m just testing so I’ll leave it for now.</p>
<p>On the next tab I can configure the OS. I’ve already configured my NAS (set up in part 2) to hold things like ISO images for installing and uploaded an Ubuntu 22.10 server image, so I’ll select that. The guest OS settings are already correctly set on Linux with a modern kernel so I’m all good there.</p>
<p>Next up is the System tab. The first option is Graphic Card. There’s a ton of options under this one, but at this point I don’t have any intention of installing anything that will care so I’ll leave it at default. Maybe at some point I’ll have a system with a GPU that I want to pass through, or will need a Windows server, but not right now. I also have to pick a machine option. Based on <a href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_virtual_machines_settings">the docs</a> as long as I don’t want to do PCIe passthrough I can stick with the default, so I will for now. Next I pick a SCSI controller. Again, referring to <a href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_hard_disk">the docs</a> the <code>VirtIO SCSI Single</code> option that it had selected by default seems perfect for me. There’s also a checkbox for <code>Qemu Agent</code>. Reading <a href="https://pve.proxmox.com/wiki/Qemu-guest-agent">the docs</a> this seems like a handy thing to have, so I’ll turn it on (looks like mostly it’s for cleaner shutdown and pausing during disk backups). The last thing on this tab is whether to enable TPM. Since I’m not making a Windows image I don’t need this, so I’ll leave it unchecked.</p>
<p>Following that we’re on to Disks. I can create multiple disks I’m sure, but for now let’s just set up one. First I make sure that the backing storage is my <code>local-zfs</code> storage, which is the NVME drive on the host, rather than my NAS. I haven’t configured the SSD in these hosts yet, I’m planning to set up <a href="https://docs.ceph.com/en/quincy/">ceph</a> on them but that’s for a future post. The other basic thing to set on this page is disk size. I’m not planning to keep this image around, so I’ll stick with the default 32GB for now. The <code>Bus/Device</code> field defaults to the SCSI interface I set up on the last tab so that seems fine. There’s an option for cache mode as well. Right now I’m not really sure what that does, but from <a href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_hard_disk">the docs</a> the default of no cache seems like it will work for me, so I’ll leave it. Taking a look at <a href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_hard_disk_discard">the docs</a> it seems like I want to have the <code>Discard</code> option checked so I’ll do that. From <a href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_virtual_machines_settings">the docs</a> <code>IO Thread</code> only seems like it really matters if I have multiple disks attached, but I don’t see the harm of turning it on so let’s do that. I’ll check <code>SSD emulation</code> since the underlying disk really is an SSD and the guest OS might as well think so too. I’ll uncheck the <code>backup</code> option on this one, since I’m planning to just destroy this VM shortly after I create it and I don’t need backups hanging around. I want to be able to try replicating this VM to different hosts, and I’d want this disk to be included, so I’ll leave <code>skip replication</code> unchecked. The last thing I have to pick is the <code>Async IO</code> option. From reading <a href="https://kb.blockbridge.com/technote/proxmox-aio-vs-iouring/">this</a> it seems like the default <code>io_uring</code> will work for me, I’m not deep enough on how this sort of thing works to have strong opinions or requirements so I’ll go with the default.</p>
<p>Now we come to CPU. For <code>sockets</code> I’ll leave it at 1, since all my hosts have only 1 physical socket. For cores my hosts have either 4 or 6 cores, so there’s definitely no point going over 6. Since this is just a test machine let’s just give it 2. For CPU type I’m going to leave it on the Default (<code>kvm64</code>). From the docs on CPU type if I set the CPU to <code>host</code> it will exactly match the CPU flags and type of my host system, but I might have migration issues across hosts, since they’re not all the exact same CPU. The default will allow easier migration, but might disable some specific CPU flags that would be beneficial. For now I’ll stick with the easy option. There’s some other stuff for CPU limits and extra CPU flags here that I’m also going to leave alone for now.</p>
<p>Now we’re on to memory. Each of these hosts has <code>32GB</code> of memory, so I don’t really have to be cheap here, at least while I’m testing. Under advanced I can set a memory floor and enable/disable ballooning. From the docs, I want to have <code>ballooning</code> enabled, even if I have the memory floor and ceiling set the same, so that my host can see how much memory the VM is actually using. If I was running a bunch of VMs with dynamic memory requirements I could see overallocating the max across them and setting the floor for each. In this case I’m just going to leave it at the default <code>2GB</code> since I’m not going to actually run anything on this VM.</p>
<p>Almost done, next up is network. I’ve only got one bridge right now so I’ll leave that selected. I’m not currently doing any VLAN stuff in my network so I’ll leave the <code>VLAN tag</code> entry blank. For model I’ll stick with <code>VirtIO</code> as the docs say that’s the one to pick for best performance as long as your host supports it. The <code>firewall</code> option is checked by default. I haven’t looked into the proxmox firewall at all at this point, but let’s leave that on for now. I can also do some rate limiting and other fancy network config here but I’m going to leave those on the default for now.</p>
<p>The only thing to do now is confirm my settings and actually create the VM. I’ll check <code>start after created</code> so it fires up right away.</p>
</section>
<section id="configure-the-vm" class="level2">
<h2 class="anchored" data-anchor-id="configure-the-vm">Configure the VM</h2>
<p>After waiting a little bit I can see my newly created VM listed under the node I set it up on. Clicking into that VM and selecting the <code>Console</code> section I can see that I’m in the Ubuntu server installation wizard. Since this isn’t a post about installing Ubuntu server I’ll work through the menus without writing everything down. Going through the install worked fine until it came time to reboot and it failed to unmount the virtual CD-ROM that had the installation ISO. I went to the hardware tab on the VM in the proxmox interface, removed the CD-ROM and rebooted. After the reboot the VM came up fine, and I was able to ssh into it from my desktop.</p>
</section>
</section>
<section id="create-a-template-image" class="level1">
<h1>Create a template image</h1>
<p>After confirming the manual VM creation process worked, I started looking into automating the process. From what I could see, most automation tools like ansible or terraform require you to have a VM template created that they can use. There are also some tools to automate the creation of templates, but let’s not get ahead of ourselves. There’s tons of docs on getting a template created and I started getting a bit of analysis paralysis going through them all, so let’s try the <a href="https://docs.technotim.live/posts/cloud-init-cloud-image/">Techno Tim</a> guide and see where that leads.</p>
<p>I was able to mostly follow the guide, and other than having to change references from <code>local-lvm</code> to <code>local-zfs</code> for storage of the disk I didn’t encounter any obvious errors. I created a new machine and it started up, but I couldn’t access it over the web interface for the shell, or see info about its IP (no qemu guest agent installed). In the cloud-init config I set the IP to be DHCP, just to see what would happen. I wasn’t able to resolve the host by name to try and ssh in using that. After checking my router I found a host just named <code>ubuntu</code> and was able to ssh into its IP with the username and ssh key I specified in the cloud init template. For a further test I created a second clone from the template. One thing I noticed was that I had to create it on the same node as the template. Presumably I can migrate it later. The second VM came up, got a new ID in proxmox, and pulled a different IP showing a different MAC address in my router. I was able to ssh into it the same way. After confirming that I shut it down and migrated it to another node, just to see how that would go. The migration went fine, the VM came back up, got the same IP, and I was able to ssh back into it.</p>
<section id="thoughts-on-manual-templates" class="level2">
<h2 class="anchored" data-anchor-id="thoughts-on-manual-templates">Thoughts on manual templates</h2>
<p>This wasn’t too bad. There are a few tweaks I’d want to apply, like adding the guest agent into the machine, but overall template creation is pretty easy. I could see wanting to update my templates semi regularly when new versions of base OSs come out though, and I’d like to understand more of the theory behind how this actually works, since a lot of what I did was pretty much copy paste. To do that, I’ll clear these out and look into some other template creation options.</p>
</section>
<section id="cleaning-up" class="level2">
<h2 class="anchored" data-anchor-id="cleaning-up">Cleaning up</h2>
<p>I don’t want lingering stuff from this experiment hanging out on my nodes, so let’s go in and see what I have to get rid of. First is the created VMs - I can stop and remove them from the UI easily enough. Same deal for the template VM. I checked the local storage through the UI as well and it looks like any virtual disks I created were removed when I got rid of the VM. The only other thing to remove was that initially downloaded cloud image, so I went into the shell for the node and just ran <code>rm</code> to get rid of that.</p>
</section>
</section>
<section id="automate-creating-a-template" class="level1">
<h1>Automate creating a template</h1>
<p>Creating templates doesn’t immediately feel like the sort of thing I’ll have to do super often and will therefore want to automate. In researching how I would do it though I found a few use cases, namely to schedule the creation of updated templates to avoid a long running <code>apt update &amp;&amp; apt upgrade</code> cycle on each newly created image. I found a nice looking <a href="https://gtgb.io/2022/07/23/proxmox-vm-templating/">post</a> that had a fairly reasonable looking workflow using a few shell scripts. Further research suggested that the “production” way to do this would be with <a href="https://developer.hashicorp.com/packer">packer</a>. That seems more complicated, but it would help me learn a more broadly applicable skill that I might be able to transfer to other projects. I honestly can’t tell if that’s a good use of my time or just <a href="https://en.wiktionary.org/wiki/yak_shaving">yak shaving</a> so I’ll try and get by without for now.</p>
<p>Following the post linked above, there’s only one pre-requisite on the proxmox nodes to run the scripts, and that’s <code>libguestfs-tools</code> in order to modify the cloud image bases we’ll be building templates from. That’s easy enough to add to the ansible playbook I’ve been using throughout this series to configure my proxmox nodes. After that there’s just four scripts I have to tweak slightly for my own requirements and then get onto at least one node. I can also set these up in ansible with some templates, which should make them easier to modify and otherwise maintain. Plus then I have them stored somewhere if I have to rebuild these nodes in the future. The repository associated with the above post is <a href="https://github.com/geektx/Proxmox-VM-Template">here</a>.</p>
<p>As a starting point I copied in the scripts as templates into an ansible role. I swapped out all the variables that were hard coded in the scripts for ansible variables, and then set what I wanted to initially test on as ansible variables in the defaults for the role. The idea is that this way if I want to build multiple templates I can just call this role with a variables file that overrides the specific things I want to change (image id, cloud image). After a little bit of fiddling I got the files copied over and ran the script, which did create a template for me. So far one advantage over the manual template from before is that this image has <code>qemu-guest-agent</code> installed, so I can see the hosts IP in the summary tab. There’s still some more stuff I’d like to sort out though.</p>
<p>By changing the storage location of the template from local storage of the node to my NAS I was able to clone the template to another node in my cluster. That image then came up in a bootloop though. Even more fun, I couldn’t stop it from the web interface, which meant I couldn’t delete it. I had to ssh into the node it was running on, run <code>ps aux | grep "/usr/bin/kvm -id &lt;VM ID&gt;"</code> and then <code>kill -9</code> that PID. Crazy. I tried creating it on the same node as the template with a target of local storage but got the same issue.</p>
<p>After looking at the docs it seems like if I want to automate building images from templates I’ll be using the template name, rather than a VM ID anyway. So I think I’ll try modifying the script to create a template with the same name but different ID on each of my nodes, which should let me provision VMs to any node. First let’s clean up the template some more though. As a future project maybe I’ll come back and figure out why building the template on my NAS causes it to boot loop, but that’s a problem for future me.</p>
<p>One thing I definitely want to be able to do is scale VMs I create off these templates up or down. 2 cores, 2GB of RAM and 2GB of disk will not always do it. To test this I create a VM from the template without modification and ssh into it. <code>df -h</code> confirms that I have 2GB of disk assigned to the VM by default. <code>lscpu</code> shows 2 cores. <code>free -h</code> confirms I have 2GB of RAM. Let’s turn the VM off and adjust those. From the Hardware tab of the VM from the proxmox UI I adjust the CPU up to 3 cores and RAM up to 4GB. Disk resizing cannot be done from the UI, so from the terminal based on <a href="https://pve.proxmox.com/wiki/Resize_disks#1._Resizing_guest_disk">the docs</a> I run <code>qm resize 100 scsi0 +5G</code> to add 5GB to the disk. Let’s fire the machine back up and see what happened. <code>lscpu</code> indeed now shows 3 cores, that’s cool. <code>free -h</code> shows the updated amount of RAM. Even <code>df -h</code> shows the correct amount of disk. That last one is frankly surprising to me because the docs indicate that only the disks should have been resized, not the logical volumes or anything else, which would have meant some commands being run within the VM to make the space available. That has also been my experience with VMs at work. Maybe it’s something fancy in the Ubuntu image I’m using? Either way, pretty sweet for now.</p>
<p>Another thing to change is how the VM authenticates over SSH. The default way I’ve been doing it is to just put my laptop’s public key in <code>~/.ssh/authorized_keys</code> using cloud-init. This works ok, but it’s not how I manage ssh in the rest of my network. See <a href="https://blog.ianpreston.ca/ssh/linux/bash/2020/05/03/ssh.html">my earlier post</a> for details, but the tldr is I want to us a certificate authority to allow any signed key to authenticate as a user, and all my host keys to authenticate themselves with a CA. The former is a bit of a convenience as I could just add a couple keys for my other devices to my <code>keyfiles</code> file and keep them up to date if I rotated keys. The Host key thing will be super handy though, since otherwise I’ll have to manually verify that I trust the host key of each new VM I start up, and if I ever tear down and replace a VM I’ll get errors on host validation. So let’s fix that. The first step is to copy the host CA key and the user CA public key into a folder on my NAS that’s accessible from proxmox so I can inject those keys into the templates. I could have ansible copy them over and encrypt them in the playbook, but I think having them on the NAS is slightly more convenient and secure, even if I’d have encrypted the keys with <code>ansible-vault</code>. Next I need to modify the template creation script to copy those files in, and modify <code>sshd_config</code> to use them. While I’m at it I can turn off password authentication over SSH for a little more security. This actually went surprisingly smoothly. I updated the <code>build_image</code> script to copy in the public key for the user CA as well as the private host CA key. Then I set it to run a very slightly modified version of the host setup script I created in my earlier post. After re-running the template build script and creating a VM from the new template I was able to ssh in from my laptop without having passed in a key file to the cloud-init template, or being prompted to validate the host key. Magic!</p>
<p>A note on name resolution. I think I remember seeing/reading this somewhere but it didn’t come back to me until I started troubleshooting. When I first create a machine from a template, if I tell it to use DHCP for IP address acquisition it gets a lease from my router with the hostname <code>ubuntu</code>. So if I want to ping/ssh the machine by name I have to use <code>ubuntu.local.ipreston.net</code> instead of <code>&lt;vm-name&gt;.local.ipreston.net</code>. I typically like to use DHCP on my servers and then just do static mappings in my router to pin them to an IP, rather than hard coding the IP itself, mostly so that I can get easy name resolution without having to put manual entries into my DNS. Even my proxmox nodes themselves which do use static IPs, I created a static mapping in my DHCP server to their MAC addresses so that all my IPs would be available in one place. Anyway, after you reboot the VM once it gets a lease with its actual hostname so just reboot it once, or manually alter the hostname when you do your static mapping.</p>
<section id="automate-creating-another-template" class="level2">
<h2 class="anchored" data-anchor-id="automate-creating-another-template">Automate creating another template</h2>
<p>Having a working Ubuntu template is pretty handy, but what if I want to branch out? Can I apply this approach to other distros? I’m pretty sure this approach will work fine with another debian based distro, and probably even another fairly standard Linux like CentOS will be fine (although I should test). But what about weird ones? Specifically I want to see if I can get this working on <a href="https://www.flatcar.org/">flatcar Linux</a> since I want to try using it for my kubernetes nodes. Let’s walk before we try running though and extend to another version of Ubuntu.</p>
<p>The first thing I want to do is tweak how I’m numbering my templates. Right now each template gets a variable set for its whole VM ID. I’d like to break that out into chunks. The first digit should just always be 8 (at least for now) to indicate a template and keep it out of the range of actual VMs I’m deploying. The next one I’m thinking should be the node the template is created on, and then the last two digits can be an identifier for the specific template. This actually wasn’t bad at all. The one variable definition gets a little long, but basically I just go from one line in defaults of <code>build_vm_id: "8000"</code> to <a href="https://github.com/ianepreston/recipes/blob/master/ansible/roles/pve_templates/defaults/main.yml#L2-L5">this</a>.</p>
<p>This relies on all my proxmox nodes having hostnames of the format <code>pve&lt;Num&gt;</code> but I can work with that. The number of digits in my IDs will change if I get more than 9 nodes or 99 templates too, but I’m not really expecting that to happen, and I don’t even think that would necessarily break anything if it did, so I won’t worry about it for now.</p>
<p>With that slight modification to the role complete I set my playbook to call the role twice, modifying the variables from the defaults for just the template name, the template number, and the URL of the cloud image to build from for Ubuntu Jammy and Kinetic.</p>
<p>Around this time I realized it was going to be a little tedious running the template build script each time I added a template, so I added a <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html">handler</a> to the role to execute the template build script whenever it made a change. It took a little bit of tweaking to figure out that I needed the full path of the script I wanted to run, as well as set it as the working directory so I could call the subscript that defines all the build variables. After those changes the handler triggered properly and built my templates whenever the script changed, or I added a new template to build.</p>
<p>At this point the general template creation process is working quite nicely for Ubuntu versions, but what about other distros? Let’s give debian a shot. I grabbed the <code>cloudgeneric</code> version of debian bullseye from their official cloud images page and plugged it into my playbook. No problem at all. The template built, I was able to build an image from it just the same as the Ubuntu ones.</p>
<p>Let’s get a bit braver and branch out to an even more different distro Rocky Linux. This one might come in handy if I want to try out anything enterprisey or just want to see what the Red Hat experience is like. I found their generic cloud images <a href="https://rockylinux.org/alternative-images/">here</a> and plugged the link into my playbook. The template built ok, but trying to run the VM I ran into problems where it got stuck on a line that said <code>Probing EDD (edd=off to disable)... ok</code> and just hung out there. Similar to the weird boot loop I got deploying from my NAS I wasn’t able to shut down the VM from the Web UI and had to go into the terminal on the node and <code>ps aux | grep "/usr/bin/kvm -id &lt;VM ID&gt;"</code> to find its PID and <code>kill -9</code> it before I could remove the VM. I guess I have to do some troubleshooting. A little searching finds that this error is pretty common, although it doesn’t actually relate to the message, but something that’s happening after. There are a few potential kernel configs I might be able to change, but as I’m poking around in the machine I notice something interesting, it’s got way more disk to start than my Ubuntu templates did. I wonder if I’m somehow filling the disk, so I use that command from the previous section and resize the disk on a newly cloned template before starting it up. Disappointingly this did not solve the problem. Another weird thing I noticed during the start up is that CPU usage on the VM is pinned at right around 50%. Since I gave it 2 cores that suggests that one core is working flat out on something. Several of the posts indicated that after about 10 minutes the system would come up. That’s obviously a terrible startup time, but I’d like to give it a while to see if I at least have the same problem. So I go do some reading and let this VM run for a while… and discover that tragically the usually perfect strategy of ignoring a problem and hoping it goes away doesn’t work in this case.</p>
</section>
<section id="examine-the-template-creation-script-and-modify-it" class="level2">
<h2 class="anchored" data-anchor-id="examine-the-template-creation-script-and-modify-it">Examine the template creation script and modify it</h2>
<p>Something about how I have my VM configured is not playing nice with Rocky Linux. It could just be a very specific thing that I only want to modify for that distro, but I also just copy-pasted most of the other template creation parameters from some guy on the internet. So before I assume that my basic parameters are the best and it’s only Rocky that needs to be modified, let’s examine those options that I’m using and see if I want to modify any of them. Maybe while I’m at it I’ll fix my Rocky issue (or introduce new ones to working distros), but at a minimum I’ll have a better understanding of what’s going on.</p>
<p>The first little bit of the script downloads a cloud image, and then uses virt-customize to update packages, install a list of packages (just qemu-guest-agent and cloud-init by default), copy in a build-info file with some metadata about the template build, copy in some ssh related files and have a script to set them up on first boot (note to self, maybe that’s the part that’s breaking in Rocky, I’ve only tested that script in debian and Arch based distros so far). That stuff (except maybe the ssh part) is all straightforward and I understand what it’s trying to do, so let’s skip to the next line:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> destroy <span class="va">${build_vm_id}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Remove the old template before you build a new one, makes sense.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> create <span class="va">${build_vm_id}</span> <span class="at">--memory</span> <span class="va">${vm_mem}</span> <span class="at">--cores</span> <span class="va">${vm_cores}</span> <span class="at">--net0</span> virtio,bridge=vmbr0 <span class="at">--name</span> <span class="va">${template_name}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create a new VM (that we’ll turn into a template later) with an ID of <code>build_vm_id</code>, memory and cores set to our variables, and a <code>virtio</code> network adapter, which is what I did in the manual template creation. Finally we give it a name based on the <code>template_name</code> variable. So far so good, but I had a lot more options available when I built a VM manually earlier in this post, anything else I should set? Reading back through my manual config I set basically everything else to defaults so I think I’m good here. Let’s see what’s next.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> importdisk <span class="va">${build_vm_id}</span> <span class="va">${image_name}</span> <span class="va">${storage_location}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ok, this is fine, I’m importing the disk image I downloaded and modified to the VM I created and putting it in the storage location I specify. All seems fine. Maybe I’ll need to revisit this if I take another crack at storing these templates on my NAS, but fine for now.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> set <span class="va">${build_vm_id}</span> <span class="at">--scsihw</span> <span class="va">${scsihw}</span> <span class="at">--scsi0</span> <span class="va">${storage_location}</span>:vm-<span class="va">${build_vm_id}</span>-disk-0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ok, here’s where I deviate from what I picked in the manual build. In my defaults (based on the script I copied in) I had <code>scsihw</code> set to <code>virtio-scsi-pci</code>, whereas in my manual build I went with <code>virtio-scsi-single</code>. I’m struggling to find the actual difference between these settings, but let’s change it for kicks for now.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> set <span class="va">${build_vm_id}</span> <span class="at">--ide0</span> <span class="va">${storage_location}</span>:cloudinit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Add the cloud-init drive, seems fine. It’s emulating a CD drive so ide makes sense.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> set <span class="va">${build_vm_id}</span> <span class="at">--nameserver</span> <span class="va">${nameserver}</span> <span class="at">--ostype</span> l26 <span class="at">--searchdomain</span> <span class="va">${searchdomain}</span> <span class="at">--ciuser</span> <span class="va">${cloud_init_user}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Add a couple defaults to the cloud-init template and set the ostype to linux (l26). No worries there.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> set <span class="va">${build_vm_id}</span> <span class="at">--boot</span> c <span class="at">--bootdisk</span> scsi0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>--boot c</code> tells it to boot from hard disk (as opposed to CD or network) and we set the bootdisk to the image that’s been mounted to the VM. Seems fine.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qm</span> set <span class="va">${build_vm_id}</span> <span class="at">--agent</span> enabled=1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This turns on qemu agent, which we want.</p>
<p>One thing I noticed from going through this is I had some lines that set multiple options, even though they weren’t necessarily related. So I cleaned that up to be one option per line. Easier to parse and modify that way.</p>
<p>I took a quick look back at the manual config section and didn’t see anything else that stood out, so I guess I have to get back to fixing Rocky Linux.</p>
</section>
<section id="get-back-to-making-rocky-linux-work-spoiler-i-do-not-succeed" class="level2">
<h2 class="anchored" data-anchor-id="get-back-to-making-rocky-linux-work-spoiler-i-do-not-succeed">Get back to making Rocky Linux work (spoiler, I do not succeed)</h2>
<p>Ok, that was a fun side quest, but let’s get back to figuring out Rocky. I re-run my template creation playbook, just in case that storage config changed anything. I also found <a href="https://forum.proxmox.com/threads/getting-probing-edd-edd-off-to-disable-ok-when-booted.97414/">a proxmox forum post</a> where someone was having the same problem with a particular RHEL image, but no solution. That post also said it worked fine with RHEL 7 and the issue was with 6. I’m trying Rocky 9 (I believe they use the same version as RHEL for compatibility) so I don’t know if that’s helpful. <a href="https://leo.leung.xyz/wiki/No_Console_Output">This post</a> suggests the output just means my console output is being redirected somewhere else, so I’m not seeing whatever the actual issue is. I guess I should fix that first regardless. One suggested solution there is to change the default tty from serial. An alternative approach there, is to check out the <a href="https://pve.proxmox.com/wiki/Serial_Terminal">proxmox docs</a> and enable serial out on the VM with <code>qm set &lt;VM ID&gt; -serial0 socket</code>. Let’s add that line to my template and see if I get anything. A little bit of progress in that it doesn’t just tell me I don’t have serial on that machine, but I also only see <code>starting serial terminal on interface serial0 (press Ctrl+O to exit)</code>, which isn’t exactly informative. Let’s ditch my ssh script setup on first boot, just to make sure that’s not what’s hanging the template. Removing it from the template script gives me the same issue, so the problem is elsewhere. Just for kicks, let’s try a different Rocky cloud image. I found <a href="https://medium.com/geekculture/create-a-rocky-linux-virtual-machine-vm-with-terraform-and-proxmox-6692a49f7b43">this blog</a> that’s using the <code>GenericCloud</code> image rather than the <code>GenericCloudBase</code> image I was using. I’m not sure why I picked <code>GenericCloudBase</code> to begin with so let’s swap over and see what happens. Still nothing. Ok, the blog also has a bunch more cloud-init modules installed than I do. Maybe one of them will fix things. Let’s add them to the package list for that template. Still no luck. Ok, back to basics. We have a blog post where someone made a template, and apparently it worked. Let’s try manually working through those instructions and see what happens. Well, first problem their link goes to a pinned daily build of Rocky that’s no longer available on the site. Fine, we’ll do the latest one and hope that there’s not just some daily build issue that’s leading to all of this. So I get the same error following the guide. After a little more digging I find a link in the rocky vault to the exact image that the blog was using. Let’s apply my template to that image. Slightly better luck. It still bootloops, but I can actually see things in the console and by being very speedy I was even able to get a screencap of the kernel panic error it’s throwing.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="{{ site.baseurl }}/images/proxmox3/panic.png" title="Rocky Panic" class="img-fluid figure-img"></p>
<figcaption>Nodes</figcaption>
</figure>
</div>
<p>Finding out that this was the issue led me to a <a href="https://forum.proxmox.com/threads/kernel-panic-installing-rocky-or-almalinux.114885/">proxmox forum</a> post where it turns out lots of people are having this issue with Rocky 9 if they set their CPU to the default <code>kvm64</code>. I reset my VM to use <code>host</code> for the CPU. That fixed the boot loop error but led to another error. At this point I decided I didn’t feel like running Rocky Linux very much.</p>
</section>
<section id="try-arch-linux" class="level2">
<h2 class="anchored" data-anchor-id="try-arch-linux">Try Arch Linux</h2>
<p>Rocky was supposed to be an intermediate difficulty distro to test out my template process. I don’t actually have a use case for it, I just figured it would be more different than debian but less different than flatcar when it comes to testing. I’m really hoping that I just got unlucky and that other distros won’t be so hard. Let’s see if that’s correct. I don’t have an immediate use case for Rocky, but I do like running Arch, it’s what my current server has. Let’s try that. Building the template goes fine, and this one actually boots to a login prompt from the proxmox UI, so we’re on a happier path than with Rocky already. At first it seemed like Arch wasn’t updating my default user. I started up the image and tried to ssh in but got a <code>connection refused</code> error. Trying to ssh in as the default <code>arch</code> user that the image uses got a <code>permission denied</code> error instead. After some testing it turns out that cloud-init just takes longer to complete on first boot in Arch, I think because it has to do more package updating. If I just left the VM running for a bit I was able to ssh right in.</p>
</section>
<section id="try-flatcar-linux" class="level2">
<h2 class="anchored" data-anchor-id="try-flatcar-linux">Try flatcar Linux</h2>
<p>I’ve never used flatcar before, but it sounds interesting and <a href="https://eevans.co/blog/garage/">this blog</a> recommended it for self hosting kubernetes so I’d like to have it available in my environment. I found <a href="https://github.com/Doc-Tiebeau/proxmox-flatcar">this repository</a> which had its own scripts to create a flatcar template. Most of it looks broadly similar to the approach I’ve been taking, so let’s try it out. I notice that flatcar images come in <code>.img.bz2</code> format instead of <code>.img</code> or <code>.qcow2</code> like the other files I’ve downloaded. I may have to add in some logic to the script to extract images in that case. As a first step though I just tried running the whole workflow as is. That got me a template built, but the VM I created off it couldn’t find any bootable media, suggesting the disk creation didn’t work as intended. Probably because I have to extract it first. After adding a little bit of logic to my image building script:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">"</span><span class="va">${image_name</span><span class="op">##</span><span class="pp">*</span>.<span class="va">}</span><span class="st">"</span> <span class="ot">==</span> <span class="st">"bz2"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bzip2</span> <span class="at">-d</span> <span class="va">${image_name}</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">image_name</span><span class="op">=</span><span class="st">"</span><span class="va">${image_name</span><span class="op">%</span>.<span class="pp">*</span><span class="va">}</span><span class="st">"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I got the VM to boot. I could auto login as user <code>core</code> over serial, but it looks like none of my other <code>cloud-init</code> config stuff worked. This post is already getting super long though so I’m going to save getting a fully working flatcar image for a separate post and declare victory on my general goal of “be able to make templates automatically”.</p>
</section>
</section>
<section id="automate-deploying-vms-from-templates" class="level1">
<h1>Automate deploying VMs from templates</h1>
<p>I’m not entirely done with templates at this point. I still want to schedule their rebuild so that I can have fresh templates to build VMs, and I need to figure out some way to be able to deploy VMs based off these templates to any node, either by recreating them on each node, or figuring out why creating them off shared storage didn’t work before. How exactly I go about some of that might depend on how I actually want to deploy VMs from these templates though, so let’s figure that out and come back to templates later.</p>
<p>Once again I’m at a decision point. I can keep using <a href="https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_module.html">ansible</a> to deploy VMs, or I can switch to <a href="https://registry.terraform.io/providers/Telmate/proxmox/latest/docs">terraform</a>. While for templates I avoided the hashicorp product and the associated learning curve, I’ve actually used terraform a bit before, and I know that it’s something I’ll want to learn for other applications like deploying cloud resources, so in this case it seems to be worth the extra effort to figure out.</p>
<p>In my <a href="https://github.com/ianepreston/recipes">recipes repository</a> I made a <code>terraform</code> directory and a <code>pve</code> subdirectory under that to contain this project. That repository already has terraform configured from my devcontainer so I’m off to a good start. I created a <code>main.tf</code> file and put in just the required info for the proxmox provider so I could run <code>terraform init</code>. This seemed to work ok, so next up is to configure the connection to my cluster.</p>
<p>Following <a href="https://registry.terraform.io/providers/Telmate/proxmox/latest/docs">the docs</a> for the provider I created a terraform user in my cluster. In theory I should automate this with ansible too as part of my proxmox setup, but I feel like I’m already getting pretty in the weeds here and would like to move towards actually accomplishing things. I guess I’ll end up regretting this if I need to entirely rebuild my cluster and can’t figure out why my terraform jobs aren’t running all of a sudden. After creating the user I added a <code>pve_creds.env</code> file to the directory (but also put it in <code>.gitignore</code>) with the username and password I’d just set up. This part is fragile too, since if I move to a different machine or delete this repository I’ll have to recreate that file. At some point in the future I’ll either figure out <a href="https://www.hashicorp.com/products/vault">vault</a> or maybe just set up the <a href="https://go.bitwarden.com/password-management-for-business-teams-organizations/">bitwarden</a> CLI to properly retrieve secrets. But that’s a project for another day.</p>
<p>With my credentials (presumably) set up, let’s try and provision a machine. There’s all sorts of fancy stuff I can eventually do to parametrize the build and I will definitely set all of that up eventually, but for now let’s start with spinning up one machine using hard coded values.</p>
<pre class="hcl"><code>resource "proxmox_vm_qemu" "test_server" {
  count       = 1
  name        = "test-vm-${count.index + 1}"
  target_node = "pve1"
  clone       = "ubuntujammytemplate"
  agent       = 1
  os_type     = "cloud-init"
  cores       = 3
  cpu         = "host"
  memory      = 4096
  bootdisk    = "scsi0"
  disk {
    slot = 0
    # set disk size here. leave it small for testing because expanding the disk takes time.
    size     = "10G"
    type     = "scsi"
    storage  = "local-zfs"
    iothread = 1
  }
  network {
    model  = "virtio"
    bridge = "vmbr0"
  }
  ipconfig0 = "ip=192.168.85.9${count.index + 1}/24,gw=192.168.85.1"
}</code></pre>
<p>The first run of <code>terraform plan</code> was disappointing because I’d accidentally used the username for the terraform user in one post I’d been reading in the environment, but set a username based on the official docs on my datacenter, so I just got a permission denied. After that though it looked promising with the following:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Terraform</span> used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> create</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Terraform</span> will perform the following actions:</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># proxmox_vm_qemu.test_server[0] will be created</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> resource <span class="st">"proxmox_vm_qemu"</span> <span class="st">"test_server"</span> {</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> additional_wait           = 0</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> agent                     = 1</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> automatic_reboot          = true</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> balloon                   = 0</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> bios                      = <span class="st">"seabios"</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> boot                      = <span class="st">"c"</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> bootdisk                  = <span class="st">"scsi0"</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> clone                     = <span class="st">"ubuntujammytemplate"</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> clone_wait                = 0</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> cores                     = 3</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> cpu                       = <span class="st">"host"</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> default_ipv4_address      = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> define_connection_info    = true</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> force_create              = false</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> full_clone                = true</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> guest_agent_ready_timeout = 100</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> hotplug                   = <span class="st">"network,disk,usb"</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> id                        = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> ipconfig0                 = <span class="st">"ip=192.168.85.91/24,gw=192.168.85.1"</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> kvm                       = true</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> memory                    = 4096</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> name                      = <span class="st">"test-vm-1"</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> nameserver                = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> numa                      = false</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> onboot                    = false</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> oncreate                  = true</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> os_type                   = <span class="st">"cloud-init"</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> preprovision              = true</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> reboot_required           = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> scsihw                    = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> searchdomain              = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> sockets                   = 1</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> ssh_host                  = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> ssh_port                  = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> tablet                    = true</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> target_node               = <span class="st">"pve1"</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> unused_disk               = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> vcpus                     = 0</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> vlan                      = <span class="at">-1</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> vmid                      = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> disk {</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> backup             = 0</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> cache              = <span class="st">"none"</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> file               = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> format             = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops               = 0</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_max           = 0</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_max_length    = 0</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_rd            = 0</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_rd_max        = 0</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_rd_max_length = 0</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_wr            = 0</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_wr_max        = 0</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iops_wr_max_length = 0</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> iothread           = 1</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> mbps               = 0</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> mbps_rd            = 0</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> mbps_rd_max        = 0</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> mbps_wr            = 0</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> mbps_wr_max        = 0</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> media              = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> replicate          = 0</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> size               = <span class="st">"10G"</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> slot               = 0</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> ssd                = 0</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> storage            = <span class="st">"local-zfs"</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> storage_type       = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> type               = <span class="st">"scsi"</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> volume             = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>      <span class="ex">+</span> network {</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> bridge    = <span class="st">"vmbr0"</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> firewall  = false</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> link_down = false</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> macaddr   = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> model     = <span class="st">"virtio"</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> queues    = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> rate      = <span class="er">(</span><span class="ex">known</span> after apply<span class="kw">)</span></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>          <span class="ex">+</span> tag       = <span class="at">-1</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a><span class="ex">Plan:</span> 1 to add, 0 to change, 0 to destroy.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That looks like the sort of thing I want to do, let’s do it with a run of <code>terraform apply</code>… It worked! It took a fair bit longer than doing it manually runtime wise (about a minute and 30 seconds), but I had read that the proxmox API is kind of slow, so that wasn’t totally surprising. At the end of the process though I had a new VM with the name and IP I’d assigned with the CPU/RAM/Disk I’d specified that I was able to ssh into. Neat! There’s a lot more I’d like to do with terraform in terms of actually deploying machines I care about of course, but this post is already getting super long so let’s save that for later.</p>
</section>
<section id="automate-creating-templates-across-nodes" class="level1">
<h1>Automate creating templates across nodes</h1>
<p>So it seems like terraform is going to be cloning templates based on their name, not their VM ID. This should mean as long as I have a template with the same name on each node, I should be able to provision VMs to any node I want from terraform. It’s definitely a bit of extra disk/CPU to do it this way, but it seems fairly clean and easy, so let’s give it at try. I think all I’ll have to do is change my playbook to target all of my nodes, since I already have logic to adjust the VM id of the template based on which node it’s on. Turns out that did indeed work, so not much to write about this one.</p>
</section>
<section id="automate-scheduled-rebuilds-of-the-templates" class="level1">
<h1>Automate scheduled rebuilds of the templates</h1>
<p>Last thing to do before I wrap up this section of my homelab saga. That’s to schedule the creation of these templates. This way if there are updated images of a particular distro, or if the packages themselves need to be updated, any machines I create from the template will have those changes reflected regularly.</p>
<p>Using the <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/cron_module.html">cron</a> module, I created a task to add an entry for each template:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Create crontab entry for template creation</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ansible.builtin.cron</span><span class="kw">:</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">"Create template {{ template_name }}"</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">minute</span><span class="kw">:</span><span class="at"> </span><span class="st">"{{ 5 * build_vm_template_num | int }}"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">hour</span><span class="kw">:</span><span class="at"> </span><span class="st">"{{ build_vm_host_digit }}"</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">month</span><span class="kw">:</span><span class="at"> </span><span class="st">"*"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">day</span><span class="kw">:</span><span class="at"> </span><span class="st">"1"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">job</span><span class="kw">:</span><span class="at"> </span><span class="st">"cd {{ install_dir }} &amp;&amp; ./build_image.sh"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I don’t want all these jobs to kick off at once, so I had the start hour vary based on the node, from 1am to 3am, and then the minute vary by the template number multiplied by 5 so each job should kick off in 5 minute intervals. If I end up with more than 12 (11?) templates I’ll have to revise this, but that’s a problem for future me.</p>
<p>I’m not 100% sure this will work, the crontab entries look fine, but I never totally trust a cron job until I’ve seen it execute at least once. Fortunately I’m writing this on the 30th of the month so I’ll be able to check back and see soon enough.</p>
</section>
<section id="conclusion-and-next-steps" class="level1">
<h1>Conclusion and next steps</h1>
<p>In this post I (over)designed a way to create Virtual Machines on my proxmox cluster for a variety of Linux distributions. To recap: so far in this series I have selected and acquired hardware, done a basic proxmox install on that hardware and clustered it, configured the underlying proxmox environment using ansible, created a number of template VMs for various Linux distributions, and set up the basic tooling necessary to create VMs from those templates using code with Terraform.</p>
<p>With all of this done, surely it’s time to actually start <em>doing things</em> on my cluster rather than setting it up, right? Not so fast! There’s still one more piece of low level infrastructure I need to set up before I’m fully ready to deploy VMs to actually do things in this environment, and that’s to configure distributed storage on the 1TB SSDs I have in each node using <a href="https://ceph.com/en/">ceph</a>. I’ll cover that in the next post.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/blog\.ianpreston\.ca");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>