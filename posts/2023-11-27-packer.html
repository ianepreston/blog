<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-11-27">
<meta name="description" content="Let’s (fail to) build some golden images">

<title>Ian’s blog - (Failing to build) Templates in Xen-Orchestra</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ian’s blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ianepreston"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">(Failing to build) Templates in Xen-Orchestra</h1>
                  <div>
        <div class="description">
          Let’s (fail to) build some golden images
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">linux</div>
                <div class="quarto-category">virtualization</div>
                <div class="quarto-category">packer</div>
                <div class="quarto-category">xcp-ng</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 27, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#up-front-warning" id="toc-up-front-warning" class="nav-link active" data-scroll-target="#up-front-warning">Up front warning</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#installing-packer" id="toc-installing-packer" class="nav-link" data-scroll-target="#installing-packer">Installing packer</a></li>
  <li><a href="#getting-sidetracked-by-xoa" id="toc-getting-sidetracked-by-xoa" class="nav-link" data-scroll-target="#getting-sidetracked-by-xoa">Getting sidetracked by XOA</a></li>
  <li><a href="#make-a-template-sr" id="toc-make-a-template-sr" class="nav-link" data-scroll-target="#make-a-template-sr">Make a template SR</a></li>
  <li><a href="#ubuntu-template" id="toc-ubuntu-template" class="nav-link" data-scroll-target="#ubuntu-template">Ubuntu template</a>
  <ul class="collapse">
  <li><a href="#get-stuck-on-templates" id="toc-get-stuck-on-templates" class="nav-link" data-scroll-target="#get-stuck-on-templates">Get stuck on templates</a></li>
  <li><a href="#get-stuck-on-metadata-restore-while-getting-stuck-on-templates" id="toc-get-stuck-on-metadata-restore-while-getting-stuck-on-templates" class="nav-link" data-scroll-target="#get-stuck-on-metadata-restore-while-getting-stuck-on-templates">Get stuck on metadata restore while getting stuck on templates</a></li>
  <li><a href="#back-to-templates" id="toc-back-to-templates" class="nav-link" data-scroll-target="#back-to-templates">Back to templates</a></li>
  </ul></li>
  <li><a href="#maybe-just-do-cloud-images" id="toc-maybe-just-do-cloud-images" class="nav-link" data-scroll-target="#maybe-just-do-cloud-images">Maybe just do cloud images</a></li>
  <li><a href="#try-doing-a-shared-sr-for-templates" id="toc-try-doing-a-shared-sr-for-templates" class="nav-link" data-scroll-target="#try-doing-a-shared-sr-for-templates">Try doing a shared SR for templates</a></li>
  <li><a href="#arch-template-failed-attempt" id="toc-arch-template-failed-attempt" class="nav-link" data-scroll-target="#arch-template-failed-attempt">Arch template (failed attempt)</a></li>
  <li><a href="#reinstall" id="toc-reinstall" class="nav-link" data-scroll-target="#reinstall">Reinstall</a>
  <ul class="collapse">
  <li><a href="#migrate-templates" id="toc-migrate-templates" class="nav-link" data-scroll-target="#migrate-templates">Migrate templates</a></li>
  <li><a href="#keep-reinstalling" id="toc-keep-reinstalling" class="nav-link" data-scroll-target="#keep-reinstalling">Keep reinstalling</a></li>
  </ul></li>
  <li><a href="#back-to-arch-installing" id="toc-back-to-arch-installing" class="nav-link" data-scroll-target="#back-to-arch-installing">Back to arch installing</a></li>
  <li><a href="#get-distracted-trying-to-figure-out-how-to-paste-into-xen-orchestra-console" id="toc-get-distracted-trying-to-figure-out-how-to-paste-into-xen-orchestra-console" class="nav-link" data-scroll-target="#get-distracted-trying-to-figure-out-how-to-paste-into-xen-orchestra-console">Get distracted trying to figure out how to paste into xen-orchestra console</a></li>
  <li><a href="#back-to-arch-installing-1" id="toc-back-to-arch-installing-1" class="nav-link" data-scroll-target="#back-to-arch-installing-1">Back to arch installing</a>
  <ul class="collapse">
  <li><a href="#fix-slow-package-downloads" id="toc-fix-slow-package-downloads" class="nav-link" data-scroll-target="#fix-slow-package-downloads">Fix slow package downloads</a></li>
  <li><a href="#install-yay" id="toc-install-yay" class="nav-link" data-scroll-target="#install-yay">Install yay</a></li>
  <li><a href="#install-guest-utilities" id="toc-install-guest-utilities" class="nav-link" data-scroll-target="#install-guest-utilities">Install guest utilities</a></li>
  <li><a href="#install-cloud-init" id="toc-install-cloud-init" class="nav-link" data-scroll-target="#install-cloud-init">Install cloud-init</a></li>
  <li><a href="#make-a-template" id="toc-make-a-template" class="nav-link" data-scroll-target="#make-a-template">Make a template</a></li>
  <li><a href="#try-building-from-the-template" id="toc-try-building-from-the-template" class="nav-link" data-scroll-target="#try-building-from-the-template">Try building from the template</a></li>
  <li><a href="#figure-out-why-the-template-didnt-really-template" id="toc-figure-out-why-the-template-didnt-really-template" class="nav-link" data-scroll-target="#figure-out-why-the-template-didnt-really-template">Figure out why the template didn’t really template</a></li>
  </ul></li>
  <li><a href="#more-fun-with-templates" id="toc-more-fun-with-templates" class="nav-link" data-scroll-target="#more-fun-with-templates">More fun with templates</a>
  <ul class="collapse">
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">Cleanup</a></li>
  <li><a href="#try-on-different-hosts" id="toc-try-on-different-hosts" class="nav-link" data-scroll-target="#try-on-different-hosts">Try on different hosts</a></li>
  <li><a href="#figure-out-actual-cloud-init-config" id="toc-figure-out-actual-cloud-init-config" class="nav-link" data-scroll-target="#figure-out-actual-cloud-init-config">Figure out actual cloud-init config</a></li>
  </ul></li>
  <li><a href="#try-packer-again" id="toc-try-packer-again" class="nav-link" data-scroll-target="#try-packer-again">Try packer again</a></li>
  <li><a href="#try-arch-with-packer" id="toc-try-arch-with-packer" class="nav-link" data-scroll-target="#try-arch-with-packer">Try Arch with packer</a></li>
  <li><a href="#give-it-a-shot-with-cloud-images" id="toc-give-it-a-shot-with-cloud-images" class="nav-link" data-scroll-target="#give-it-a-shot-with-cloud-images">Give it a shot with cloud images</a>
  <ul class="collapse">
  <li><a href="#xo-cli-problems" id="toc-xo-cli-problems" class="nav-link" data-scroll-target="#xo-cli-problems">XO-CLI problems</a></li>
  </ul></li>
  <li><a href="#start-fresh" id="toc-start-fresh" class="nav-link" data-scroll-target="#start-fresh">Start fresh</a>
  <ul class="collapse">
  <li><a href="#first-hurdle-no-cloud-init" id="toc-first-hurdle-no-cloud-init" class="nav-link" data-scroll-target="#first-hurdle-no-cloud-init">First hurdle, no cloud-init</a></li>
  <li><a href="#try-manual" id="toc-try-manual" class="nav-link" data-scroll-target="#try-manual">Try manual</a></li>
  <li><a href="#run-packer-again" id="toc-run-packer-again" class="nav-link" data-scroll-target="#run-packer-again">Run packer again</a></li>
  </ul></li>
  <li><a href="#give-up" id="toc-give-up" class="nav-link" data-scroll-target="#give-up">Give up</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="up-front-warning" class="level1">
<h1>Up front warning</h1>
<p>After an absurd amount of hacking I did not find a good way to automate template creation. You can read this to follow my descent into madness and/or to see if I already tried and failed at the approach you were considering trying. Let this be a warning. I’ll make a subsequent post about how I ended up doing this.</p>
</section>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>When I was <a href="../posts/2023-01-21-proxmox3.html">learning proxmox</a> earlier this year I considered using <a href="https://www.packer.io/">packer</a>. At the time it seemed like a lot of work, and I found some relatively simple scripts I could run to build templates for the operating systems I was interested in. Now I’m testing out <a href="../posts/2023-11-12-xcp-ng.html">xcp-ng</a> and I need to create template images again. In the future if I find myself wanting to deploy any of those images to another environment and I’ve figured out some xcp-ng specific way of doing things I’ll have to relearn again. At this point it’s starting to make more sense to bite the bullet and figure out packer. Plus, I’ve been writing a fair bit of terraform at work so the hashicorp language makes more sense to me. That should help with the learning curve. This post will document my learn by doing attempts to figure out packer. It’s definitely not a how-to guide, more a reference for myself in the future. That said, it might be helpful to others who are considering learning packer to see what they’re in for.</p>
</section>
<section id="installing-packer" class="level1">
<h1>Installing packer</h1>
<p>My initial instinct is to add packer to my IaC devcontainer. However, as a simple learning exercise I’ll probably be building some docker containers, and I don’t feel like troubleshooting whether the errors I’m getting are from packer or something specific to docker-in-docker. So for now I’ll just install it right into my WSL install of Ubuntu on my workstation.</p>
<p>The docs have a pretty easy install guide so that goes fine, except for the part where it was silently prompting me for my <code>sudo</code> password and I thought it froze.</p>
<p>Beyond that I can run <code>packer -v</code> to make sure it’s loaded and determine that I’m running version <code>1.9.4</code>. Cool, let’s build something</p>
</section>
<section id="getting-sidetracked-by-xoa" class="level1">
<h1>Getting sidetracked by XOA</h1>
<p>I kept reading about how Xen had pre-packaged templates and even a full blown kubernetes deployment available in Xen, but I couldn’t see it in my UI. After some <a href="https://xcp-ng.org/forum/topic/7957/question-about-using-hub-as-a-xo-built-from-sources">reading</a> I realized it wasn’t included in the source built version I was running. I can deploy XOA free edition and get the templates, but I’ll still want the source built version to handle my backups and other stuff that’s not included in free tier. A little hacky, but fair enough since I’m not giving them any money. After signing up for an account I got this cool web based deploy link where I pointed it at a host, put in my password (after accepting self-signed certs) and it auto deployed XOA onto the host.</p>
<p>Taking a look at the templates, my options were fairly limited, and the kubernetes auto deploy seemed interesting, but I don’t think I’m ready for that yet. It’s cool that it exists, and I think if I built a cluster again I’d bootstrap something like this instead of going the docker route I did (unless xcp-lite actually works in which case I won’t need either).</p>
<p>I did want to test restoring my metadata backups, but unfortunately that feature is pro tier so I couldn’t do it. I was able to manually export my config and load it into XOA and have all my hosts show up, so that was nice. For now I’ll shut this VM down and go back to doing things with packer.</p>
</section>
<section id="make-a-template-sr" class="level1">
<h1>Make a template SR</h1>
<p>One of the things I found annoying about proxmox was that even if my machines were clustered I had to create the same template on each machine. I think I can get around this with xcp, let’s find out. In my NFS share for XCP stuff I make a new folder called <code>templates</code>.</p>
<p>I then add that as a NFS SR for images on each node. It’s a little annoying that I have to replicate it, but I still think that’s better than worrying about pools at this point. I’ve been trying to use Chat-GPT to help with this sort of work and I asked if I could export SR configs across pools. It hallucinated that there was an export option, which sure would have been nice. Anyway, it’s only a few hosts and my browser remembers all the configs in the boxes so it only took a few minutes to set up all hosts.</p>
</section>
<section id="ubuntu-template" class="level1">
<h1>Ubuntu template</h1>
<p>The <a href="https://github.com/ddelnano/packer-plugin-xenserver">xenserver packer plugin repo</a> has an example section that builds Ubuntu 20.04. That’s a bit old for my taste at this point, but let’s try and get it working and then adapt to it and other OS installs later.</p>
<p>I initially wrote a script that exported my variables for username and passwords in the form <code>PKR_ENV_&lt;variable&gt;</code> but for whatever reason it didn’t seem to like that and claimed that I hadn’t set those variables. I modified the script to export to json instead and that seemed to work. Sort of, I got a new error after that:</p>
<p><code>The iso_checksum_type must be specified.</code></p>
<p>The ISO checksum seems like it should be coming from a data source that pulls it from a page maintained by Ubuntu with hashes for their ISOs. Everything looks ok, and if I hard code in the release version to the URL I can get to a page that shows hashes.</p>
<p>I’m not sure at this point if something is going wrong with my variable interpolation or I missed some other step. Adding <code>PACKER_LOG=1</code> in front of my build command got me a lot more verbose output, but nothing useful.</p>
<p>Running <code>packer inspect</code> instead of <code>packer build</code> showed me some outputs (ChatGPT hallucinated some other terrible ideas about how to get this stuff, I still have mixed feelings about working with it).</p>
<pre><code>local.ubuntu_sha256: "[\n  \"b8f31413336b9393ad5d8ef0282717b2ab19f007df2e9ed5196c13d8f9153c8b\",\n]"</code></pre>
<p>That output appears basically correct since the variable I’m applying it to looks like this <code>iso_checksum      = "sha256:${local.ubuntu_sha256.0}"</code>.</p>
<p>Ugggh, it’s an error in the examples. There’s now an <code>iso_checksum</code> and an <code>iso_checksum_type</code>. I should have looked more closely at the error message. Ok, modifying the spec to break those two parts up and we’re back in business. On to the next error:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">xenserver-iso.ubuntu-2004:</span> output will be in this color.</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Build</span> <span class="st">'xenserver-iso.ubuntu-2004'</span> errored after 5 milliseconds 434 microseconds: Post <span class="st">"https://xo.&lt;sensitive&gt;.net"</span>: dial tcp 192.168.10.10:443: connect: connection refused</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Oh, I’m not supposed to point this at my xen-orchestra, it’s supposed to go against an xcp-ng host. This is going to be confusing for a while, I’m pretty sure terraform goes against xo. I guess I’ll find out.</p>
<p>This time we get building, but it hangs on <code>Step: Wait for VM's IP to become known to us.</code> Bringing up the console on the machine in XO it’s hung on a prompt for autoinstall that’s expecting user input.</p>
<p>I tried running it again so I could see the console output and this time (after at least half an hour) it seemed to work.</p>
<p>Upon closer inspection it only shows up in one of my pools (we’ll try booting later) and I have a bunch of stuff in the root of my xcp-ng storage location on my NAS, whereas the templates were all supposed to be in a subfolder. Did I mess up my storage location? Hmmm, looks like I did, or it didn’t like my subfolder. Let’s delete this template and try again. Ahhh, yeah after you put in the subfolder when defining a SR path you have to hit the little search icon beside it or it doesn’t actually add the path. Probably there as a validation step but it sure tripped me up. I’ll make it on the local and one other host, I would still like them to share. Ahhh, ok. Each pool is making a UID subfolder, so they won’t be sharing templates unless I pool them. I can probably at least create them in one pool and then replicate them to my others. For how often I will want to create or update templates I probably don’t need to overengineer this. I could even use one host to build all my initial images and then migrate them, but that seems like a pain.</p>
<section id="get-stuck-on-templates" class="level2">
<h2 class="anchored" data-anchor-id="get-stuck-on-templates">Get stuck on templates</h2>
<p>There were a bunch of empty templates along with the provisioned machine I created that I didn’t think I needed, so I deleted them. Now when I try and install Ubuntu with packer it fails. Which is weird, I didn’t realize I was using them. So I either have to figure out how to get them back, or how to have packer build without them. I can always restore a backup of my config, I’ve been meaning to do that anyway, but let’s see if I can restore them some other way first. Allegedly there’s a way to export/import them, but I can’t see anything.</p>
</section>
<section id="get-stuck-on-metadata-restore-while-getting-stuck-on-templates" class="level2">
<h2 class="anchored" data-anchor-id="get-stuck-on-metadata-restore-while-getting-stuck-on-templates">Get stuck on metadata restore while getting stuck on templates</h2>
<p>Trying a restore…. I can’t seem to restore. This is why you test these things I guess. What’s going on here? Maybe it’s something about the pool metadata? I think I should have broken those into two tasks, since it’s asking me to do a pool restore at the same time. Nope that’s not it. Looking at the error it’s trying to find the backup in the wrong path. If I follow the mount point on my XO server I can see the backup file, but it’s trying to load it from a weird subdirectory.</p>
<p>The error is</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ENOENT:</span> no such file or directory, open <span class="st">'/run/xo-server/mounts/3f885501-70f9-4219-8707-2a6515b0814e/opt/xo/xo-builds/xen-orchestra-202312021218/packages/xo-server/xo-config-backups/9a515773-8912-4677-9e37-9e187341ecb9/20231129T070000Z/data.json</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And the actual path is</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/run/xo-server/mounts/3f885501-70f9-4219-8707-2a6515b0814e/xo-config-backups/9a515773-8912-4677-9e37-9e187341ecb9/20231129T070000Z/data.json</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’m not sure why it added all that other stuff in.</p>
<p>Just for kicks let’s head over to my XOA install. Backups are a premium feature so I turn on my trial version. The restore runs fine from there, so it is some issue with the source build. Now what do I want to do with this information? I mean, VM backup and restore worked. It’s not great that this doesn’t, but is it the end of the world? I did that manual backup restore to XOA and it worked ok. I wonder if I can reverse that to get this back in shape? If that works I’ll just have to remind myself to do manual xen-orchestra backups before I start messing with things. Or rely on actual VM backups instead.</p>
</section>
<section id="back-to-templates" class="level2">
<h2 class="anchored" data-anchor-id="back-to-templates">Back to templates</h2>
<p>Having fired up xen in the XOA appliance and the original docker container I was using I can no longer see templates on my hosts when I create a new VM anywhere. So that’s clearly not a xen-orchestra thing, but an xcp-ng thing. Still figuring all that out. That at least helps me figure out where to go for docs and possible solutions.</p>
<p>From reading it seems like I might just have to reinstall. I do want to test a reinstall eventually, but not right now.</p>
</section>
</section>
<section id="maybe-just-do-cloud-images" class="level1">
<h1>Maybe just do cloud images</h1>
<p>I’m starting to feel like packer is just not the tool for me. On proxmox I just used cloud images as a template and then applied some settings in the cloud-init config. XCP-ng has good support for cloud init (allegedly) and it looks like I can save template configs for it at the XO level, so that would be reproducible across hosts. Let’s give it a try. <a href="https://sysmansquad.com/2021/07/07/creating-an-ubuntu-20-04-cloud-template-cloud-init-configuration-in-xen-orchestra/">This blog</a> seems like a fairly straightforward example of what I want to do. Let’s give it a try.</p>
<p>Ok that worked great. I modified the cloud-init slightly and it installed the guest management utilities and everything. I think by just making a couple custom cloud-init configs I can have an easily built template system.</p>
</section>
<section id="try-doing-a-shared-sr-for-templates" class="level1">
<h1>Try doing a shared SR for templates</h1>
<p>When messing around with recreating SRs for the templates it kind of looked like I had the option to attach newly created SRs on hosts to the same path as existing ones I’d created. <a href="https://xcp-ng.org/forum/topic/5336/copy-template-between-hosts">This forum post</a> also makes it sound like I should be able to do that. Let’s give it a try.</p>
<p>To start I delete the old template SRs I created (after deleting the template I made) and clear them out from my NAS.</p>
<p>Next I create one on a single pool using the same config as before. Then I do the same on a second host. When I hit the search button on that folder the “storage usage” section fills in with an ID for the last one I created. I click the “Reattach SR” button, and get an error that it exists. So it doesn’t look like they can share. That’s ok. I can still create templates once and then copy them to any machines I want to provision them to. Not perfect but not terrible either.</p>
</section>
<section id="arch-template-failed-attempt" class="level1">
<h1>Arch template (failed attempt)</h1>
<p>The Ubuntu template was easy enough, and it’s handy to have an Ubuntu template available, but I generally prefer running Arch these days, so let’s build for that to start.</p>
<p>It doesn’t look like there is an OVA cloud image for Arch. There is a way to <a href="https://xcp-ng.org/docs/migratetoxcpng.html#from-kvm-libvirt">convert KVM</a> but it feels like it might be more work than just making my own template.</p>
<p>As I’m doing this I’m realizing something is messed up about my ISO SRs. They should all be pointing to my NAS, which has a debian and an Ubuntu image on it. But on two hosts I see only ubuntu and some packer stuff, on another there’s an Arch ISO. None of which match up with what’s actually happening on my NAS. Ahhh, again, I didn’t actually add the path properly so there’s some overlap going on. That’s sorted now and I can actually see just the ISOs I was expecting. Apparently sharing ISOs across SRs is ok.</p>
<p>I can’t seem to create a VM though, probably because I borked my templates. I can’t seem to add a network or a disk when I go to create a VM. Something in the template setting must handle that in a way I can’t see. I think it’s reinstall time.</p>
</section>
<section id="reinstall" class="level1">
<h1>Reinstall</h1>
<p>Let’s start with a host that’s not running XO. Not that I couldn’t get that back, but I’d rather not have to. The reinstall process is pretty straightforward. I didn’t have to re-enter any of my config, and the host came back up in its same pool, with all its SRs attached. I did need to apply patches again, but that’s to be expected. Once it came back up I could see all the default templates that came with the VM, and creating a new VM seemed to work better, I could see the network options and pick storage.</p>
<section id="migrate-templates" class="level2">
<h2 class="anchored" data-anchor-id="migrate-templates">Migrate templates</h2>
<p>Before I go further, let’s see if I can now migrate all these templates to my other hosts rather than reinstall. That didn’t seem to work, every copy got a <code>no opaque ref found</code> error. I think there must be something fancy about those.</p>
</section>
<section id="keep-reinstalling" class="level2">
<h2 class="anchored" data-anchor-id="keep-reinstalling">Keep reinstalling</h2>
<p>I was going to want to test this anyway, let’s do it now. I’ll bring down another node, this one with my XOA VM on it and to a reinstall there. Install went fine, the VM was still there and booted ok when it came back up. Nice! Ok, in theory I can bring down my last node running XO, reinstall, and power it back on without any migration. let’s test.</p>
<p>Came back up fine. That’s pretty nice.</p>
</section>
</section>
<section id="back-to-arch-installing" class="level1">
<h1>Back to arch installing</h1>
<p>Ok, now that templates are working again and I have my ISO SR sorted, let’s build an arch template. <a href="https://www.driftinginrecursion.com/post/arch_linux_guests_in_xcp-ng/">This blog</a> suggests it won’t be that hard, do a basic Arch install, install yay and xen guest utils. I’ll probably add cloud-init stuff too.</p>
<p>The basic install went ok, but package downloading was super slow. I’m not sure if that’s a driver issue or something with my mirrors. I’ll have to do some more testing before I make a template of it.</p>
<p>As a start let’s try installing and running <a href="https://wiki.archlinux.org/title/Reflector">reflector</a>. It’s probably a good practice to have that anyway. While I’m at it I’ll install <code>ssh</code> and <code>iperf3</code>. Being able to ssh in is definitely handy since it lets me paste commands. I still can’t seem to paste into the command console from xen-orchestra. Maybe I’ll look into that while reflector is running.</p>
</section>
<section id="get-distracted-trying-to-figure-out-how-to-paste-into-xen-orchestra-console" class="level1">
<h1>Get distracted trying to figure out how to paste into xen-orchestra console</h1>
<p><a href="https://xcp-ng.org/forum/topic/7848/copy-paste-not-working-from-xen-orchestra-community-edition-or-xcp-ng-center">Well this is discouraging</a></p>
<p>I did notice that there’s a little box above the console for copying, but it’s barely responsive when I type and doesn’t seem to let me paste. I guess the real solution is to set up SSH or a proper remote desktop ASAP.</p>
</section>
<section id="back-to-arch-installing-1" class="level1">
<h1>Back to arch installing</h1>
<section id="fix-slow-package-downloads" class="level2">
<h2 class="anchored" data-anchor-id="fix-slow-package-downloads">Fix slow package downloads</h2>
<p>So prior to running reflector I decided to try <code>iperf3</code>. Fortunately I’m pulling a solid gigabit between two machines on my network, so it’s not a weird driver thing, I probably just picked terrible mirrors in the installer. Let’s do reflector. Ok, after running reflector my package downloads are way faster. Might as well start and enable the systemd timer for it as well, I’d like that to happen somewhat regularly on all my installs.</p>
</section>
<section id="install-yay" class="level2">
<h2 class="anchored" data-anchor-id="install-yay">Install yay</h2>
<p><code>xen-guest-utilities</code> aren’t in the base package manager, but they are in the AUR. So to get them I’ll need an AUR helper. I’ve generally been happy with <a href="https://github.com/Jguer/yay">yay</a> and it’s still actively developed so why switch? I grabbed the pre-built binary from the releases section so I didn’t have to install a bunch of build tools onto my base template.</p>
</section>
<section id="install-guest-utilities" class="level2">
<h2 class="anchored" data-anchor-id="install-guest-utilities">Install guest utilities</h2>
<p>Looks like the package I want is called <code>xe-guest-utilities-xcp-ng</code>. Sounds right. I chose to remove the make dependencies after installation, since I’m trying to keep this install light. The install completed ok but XO didn’t detect it as having a management agent. When in doubt reboot. Nope. Ahh, here we go, in the notes from the AUR package someone is talking about an issue that’s preventing the <code>xe-linux-distribution.service</code> from starting. Once I start that service the management agent is detected and my IP shows up. Enable the service so it persists across reboots (realized I forgot to do that with ssh when I couldn’t get back in after a reboot.)</p>
</section>
<section id="install-cloud-init" class="level2">
<h2 class="anchored" data-anchor-id="install-cloud-init">Install cloud-init</h2>
<p>I think this is the last thing I want to install on this template. There are a few other things I basically always use, but to start at least I want this template to have just the absolute minimum of a VM so that I can customize it later. I’m even removing <code>iperf3</code>. I guess reflector is a bit of a cheat in that regard, but given how awful the mirrors I picked were maybe that’s ok. I install <code>cloud-init</code> and <code>cloud-guest-utils</code>. According to the <a href="https://wiki.archlinux.org/title/Cloud-init">wiki</a> I need the latter if I want my disk to resize, which I certainly do. Ok, both are installed. I think we’re ready to turn this into a template.</p>
</section>
<section id="make-a-template" class="level2">
<h2 class="anchored" data-anchor-id="make-a-template">Make a template</h2>
<p>Based on <a href="https://sysmansquad.com/2021/07/07/creating-an-ubuntu-20-04-cloud-template-cloud-init-configuration-in-xen-orchestra/">this post</a> I think all I have to do is run <code>cloud-init clean</code> and shutdown the VM before I turn it into a template. I wasn’t sure if I had to do that command as root or not, it didn’t fail on either so I ran both to be safe and then shut down. Back in XO I head over to the advanced tab for my VM and click “convert to template”. That appears to be done.</p>
</section>
<section id="try-building-from-the-template" class="level2">
<h2 class="anchored" data-anchor-id="try-building-from-the-template">Try building from the template</h2>
<p>If/when this works I’ll have to mess around with saving cloud init configs, but for now let’s just hack one together quickly. I go to create a new VM on the host that has my template (I’ll copy it to the others later if I’m happy with it). I pick the template from the list, give the VM the very creative name <code>archtest1</code>.</p>
<p>Here’s the dump of the user cloud config I tried. I left the network one alone:</p>
<pre><code>#cloud-config
hostname: {name}%
ssh_authorized_keys:
  - &lt;My public key spec&gt;
packages:
  - vim
users:
   - default
system_info:
   default_user:
     name: ipreston
     lock_passwd: true
     gecos: arch Cloud User
     groups: [wheel, adm]
     sudo: ["ALL=(ALL) NOPASSWD:ALL"]
     shell: /bin/bash</code></pre>
<p>I had to be careful to create the SR on the local disk for the host instead of my templates SR, which runs on my NAS, I’m sure that wouldn’t have been amazing for performance. I gave it a 20G disk so I could see if the expansion worked properly out of the box.</p>
<p>With that it was time to hit create and see how things went.</p>
<p>Well it started, so that’s great. But my password still worked, which it shouldn’t, and it pulled the exact same IP as the template, which suggests the MAC address hadn’t changed. That will be problematic in the future. Taking a closer look, my ssh key hasn’t been added, vim hasn’t been installed, and my partition hasn’t been expanded. I can see 20G of available space, but I’ve only still got the 10 allocated. No bueno.</p>
</section>
<section id="figure-out-why-the-template-didnt-really-template" class="level2">
<h2 class="anchored" data-anchor-id="figure-out-why-the-template-didnt-really-template">Figure out why the template didn’t really template</h2>
<p>At this point I’m getting dangerously close to going back to packer. Ok, re-reading the <a href="https://wiki.archlinux.org/title/Cloud-init">Arch wiki</a> maybe I was supposed to enable some of those services before shutting down? I can’t find any examples specific to Arch online but <a href="https://xen-orchestra.com/blog/centos-cloud-template-for-xenserver/">this blog</a> doesn’t show anything like that for CentOS. From a bit more careful reading of the Arch wiki it does look like I want <code>cloud-init.service</code> and <code>cloud-final.service</code> enabled. Let’s give that a shot.</p>
<p>I create a new VM from my “template” so I at least don’t have to redo all that work. I enable those services above, run <code>cloud-init clean</code> as my user and root again to be safe and poweroff. Back to the advanced tab on the management interface to create a template.</p>
<p>Ok, new VM based off this updated template. The create button spins for a while after I hit it. That’s either good because cloud-init is doing things upon creation like installing vim, or bad because something is screwed up and stuck in a boot loop. Let’s wait and find out.</p>
<p>Ok, it pulled the same IP address, but I also can’t login with my password, so maybe something happened? Let’s try to ssh in with my key. Oooh, I get a big warning that the remote host key has changed, that’s actually good! It might mean that other stuff is different. Let’s remove that old key and try again. Well I definitely can’t connect via password, but it’s also rejecting my key, so maybe something went wrong with my cloud config? Kind of hard to test if I can’t actually get into the host though. Weirdly this feels like progress. I’ll stop and remove this machine and try creating another one with the easier way of passing just my key in, maybe it was just something dumb about how I did the cloud config file. I’ll have to sort that out eventually, but one thing at a time.</p>
<p>While I’m messing around, let’s make a note of what MAC this machine is given for future attempts to compare against: <code>a6:81:06:16:c3:b5</code>.</p>
<p>Ok, still can’t get in with the key I added, so something else is wrong here.</p>
<p>Let’s create a new VM from the first template, I can’t make anything from the one I just tried since I can’t boot back into it. For reference it gets a MAC of <code>06:31:62:32:8b:59</code></p>
<p>From here I want to take a look at <code>/etc/cloud/cloud.cfg</code> to see if there’s stuff I should be adding to make it pick up my data sources or whatever else I want it to do.</p>
<p>Ok, looking in this file there’s no <a href="https://wiki.archlinux.org/title/Cloud-init#Configuring_data_sources">datasource_list</a> entry. Per the <a href="https://xen-orchestra.com/docs/advanced.html#requirements">XO docs</a> I need the <code>opencloud</code> type to send in my config. Let’s try adding an etry with that.</p>
<pre><code>datasource_list: [ NoCloud, ConfigDrive, OpenNebula, Azure, AltCloud, OVF, MAAS, GCE, OpenStack, CloudSigma, Ec2, CloudStack, None ]</code></pre>
<p>Ok, with that added I think I can enable those two services, run clean and shut down again. Back in the menu convert it to a template, and try to spin up a machine from it. Again I just give it my key for now and set the disk to 20G so we can make sure that works (assuming I can actually get in this time).</p>
<p>First good sign, this one has a new MAC (<code>5a:62:06:7d:c2:e3</code>) and the guest tools seem to be working. I think because I didn’t set a default name here the user should be <code>arch</code>, let’s try and ssh in with that. I’m in! My disk is the full 20G too, so that worked as well! Awesome!</p>
</section>
</section>
<section id="more-fun-with-templates" class="level1">
<h1>More fun with templates</h1>
<p>At this point I am tempted to skip ahead to doing terraform deploys and triggering ansible upon deployment and other fun stuff like that. Before I get too crazy though, let’s clean up and do a bit more testing of what I’ve done. After that I think it might be worth going back to packer and trying again. What I did for arch was pretty manual, and even though I should really only have to have done it that one time, I’d like to have it in code just to be safe, and to possibly extend it.</p>
<section id="cleanup" class="level2">
<h2 class="anchored" data-anchor-id="cleanup">Cleanup</h2>
<p>It’s important to tidy up after yourself before moving on to the next thing:</p>
<ul>
<li>Stop and delete the test VM created from the template.</li>
<li>Delete the broken Arch templates (the one that didn’t have cloud-init enabled and the one it was broken on)</li>
<li>Rename <code>archtemplate2</code> to something more appropriate.</li>
</ul>
</section>
<section id="try-on-different-hosts" class="level2">
<h2 class="anchored" data-anchor-id="try-on-different-hosts">Try on different hosts</h2>
<p>I could just create all my VMs on one host and then migrate them to their destination, but why? Let’s copy that template to another host and try provisioning there. The copy isn’t super fast, but it’s almost certainly faster than re-building the template a second time, even if I had automation around that.</p>
<p>While I’m at this, let’s try creating it with the cloud config I wrote up above this time. If I’ve got that right I should ssh as my usual username instead of <code>arch</code>, and I updated it slightly to install iperf3, since I added <code>vim</code> to the base image to edit the cloud config. There’s basically no machine I wouldn’t want vim on so I’m ok with that.</p>
<p>Ok, that didn’t work. Let’s try again with just the ssh key and I’ll figure out my cloud config later.</p>
<p>Doing it with just my basic ssh key passthrough worked fine. So there’s something weird about what I’m doing with my cloud config.</p>
</section>
<section id="figure-out-actual-cloud-init-config" class="level2">
<h2 class="anchored" data-anchor-id="figure-out-actual-cloud-init-config">Figure out actual cloud-init config</h2>
<p>To be honest I’m not sure how much I’m going to end up caring about this. I don’t really care about the default username, it would be slightly convenient to have it be <code>ipreston</code> instead of <code>arch</code> or whatever. If I really cared I could make a new template and set that as the default in <code>/etc/cloud/cloud.cfg</code> as well. I guess I might want to specify static IPs, although generally I prefer static assignment of DHCP leases. Maybe if I’m making some hosts that need a management network that they just talk on that I’m handling outside of my router. For package installation and other post install stuff, I think I’d generally rather go with ansible. Maybe there’s some one off things like signing my host keys with my CA that would fit there. Generally I think I just want to know how this works because it’s there and I don’t like not being able to understand it.</p>
<p>Rather than starting from the XO template, let’s try creating one based on what’s in the <a href="https://wiki.archlinux.org/title/Cloud-init#Archiso">Arch wiki</a>. From what I’ve read even though the cloud-init spec is supposed to be universal there’s a fair bit of bespoke stuff. I don’t know how valid that is, but this seems like a place to start from.</p>
<p>Ok, with that format I can set the default username and have it authorize my ssh key. If I’ve got that set up off the hop then I can do the rest with ansible. It might still be nicer to do some things with cloud-init, but I’ve got a template saved that I can use for at least arch that will get me a bare bones machine. That’s good enough for now.</p>
</section>
</section>
<section id="try-packer-again" class="level1">
<h1>Try packer again</h1>
<p>Now that I know I can create templates, and I’ve fixed having those default templates available to me, let’s see if I can build that Ubuntu template yet.</p>
<p>Way back near the beginning of this post I have was having flaky issues with completing the template build, that I then exacerbated by not specifying my SRs correctly and deleting the base templates that were required.</p>
<p>I’ve lost track of what exactly I was stuck on before, I think it was just that I broke a bunch of unrelated things after that last flaky attempt. Let’s just try running the packer install again and see what happens:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">xenserver-iso.ubuntu-2004:</span> Unable to get SR: Found more than one SR with the name <span class="st">'templates'</span>. The name must be unique</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I guess since they’re not actually shared I might as well name them accordingly.</p>
<p>After fixing that and waiting 22 minutes my build finished! It didn’t delete the VM it built, but I had that as a setting, and it does seem to have created a new template.</p>
<p>Let’s clean up and try creating a VM from that template. I remove the built VM, then start a new VM from the packer template. I’ll use the custom cloud config that worked on Arch, and give it a 15G disk to see if resizing worked. I think there’s going to be other stuff I need to do to get this working the way I want, but we can test at least the basics here. Well, good start, it booted. And the management agent was detected. It didn’t update the hostname as I’d have expected from my cloud config so that’s not a great sign. I can log in with the <code>testuser</code> username and <code>ubuntu</code> password that was hard coded into packer and should have been overwritten. So I guess the cloud-init part didn’t work at all. That’s kind of the whole point of having templates so that’s obviously disappointing.</p>
<p>Interestingly, the cloud-init service appears to be enabled, and the default cloud config should have made an ubuntu user with a disabled password. I wonder if that one works with my key? Or maybe my default user will. If it’s just a matter of disabling this test user that’s one thing. Nope, no luck with any of those. Just for kicks I check <code>/etc/passwd</code> and confirm that’s the only user that exists (besides the system ones).</p>
<p>Taking a closer look at <code>/etc/cloud/cloud.cfg</code> it doesn’t look like I have that <code>datasources_list</code> array that I needed in Arch to make things work. So presumably I need some way to add that line to the file as part of template creation.</p>
<p>From the VM I created from the template I run <code>cloud-id</code> as per <a href="https://cloudinit.readthedocs.io/en/latest/howto/identify_datasource.html">the docs</a> to confirm (or at least support the theory) that the issue is it’s not seeing my no-cloud config format. It just returns <code>none</code>.</p>
<p>From reading up a bit on <a href="https://developer.hashicorp.com/packer/docs/templates/hcl_templates/blocks/build/provisioner">provisioners</a> it looks like I should be able to add some steps to my build block to do the things I want.</p>
<p>There might be better ways than just calling shell commands though, let’s do a bit of reading and look into that first in the <a href="https://developer.hashicorp.com/packer/docs/provisioners">provisioners</a> docs.</p>
<p>From a quick read there’s basically file and shell provisioners. I think if I want to do fancier things the idea is to write a shell script and copy it into the build with the file provisioner and then run it with the shell provisioner. That seems reasonable to me.</p>
<p>Let’s just try a little provisioner block and see what happens:</p>
<pre class="hcl"><code>  provisioner "shell" {
    inline = [
      "echo provisioning all the things",
      "echo 'datasource_list: [ NoCloud, ConfigDrive, OpenNebula, Azure, AltCloud, OVF, MAAS, GCE, OpenStack, CloudSigma, Ec2, CloudStack, None ]' &gt;&gt; /etc/cloud/cloud.cfg",
    ]
  }</code></pre>
<p>It just dumps it to the end of the file, we’re not being fancy here, but let’s see if it even works.</p>
<pre><code>==&gt; xenserver-iso.ubuntu-2004: Provisioning with shell script: /tmp/packer-shell475973010
==&gt; xenserver-iso.ubuntu-2004: /tmp/script_510.sh: 3: cannot create /etc/cloud/cloud.cfg: Permission denied
    xenserver-iso.ubuntu-2004: provisioning all the things</code></pre>
<p>Maybe it’s as simple as needing to put <code>sudo</code> on it. Let’s give that a shot before trying anything super fancy. The feedback loop on this is real slow though so if that doesn’t work I’m going to have to figure out a smarter way to do things.</p>
<p>I’m back to having issues being prompted by the autoinstaller. I’ve put in the change in <a href="https://github.com/ddelnano/packer-plugin-xenserver/issues/47">this issue</a>, but that hasn’t sorted it. There’s also <a href="https://github.com/ddelnano/packer-plugin-xenserver/issues/26">this issue</a> let’s see if I can figure out what to do from it. Ok, it’s still failing arbitrarily. Also my <code>sudo</code> on the cloud config didn’t fix it. Probably because that user isn’t added to the sudo group. Back in my <code>user-data</code> file let’s add some late commands to add that user to sudo, and also just do the cloud config line addition there.</p>
<p>Ok, you can’t add the user to sudo with late commands because it doesn’t exist yet. Let’s at least see if my cloud config update worked. The template built at least. Let’s see if I can create a VM with my cloud config.</p>
<p>It creates but it doesn’t apply my cloud config.</p>
<p>That’s not great. I think I’ll probably create Ubuntu images from cloud templates anyway, so I’m not sure how much time I want to invest in this particular issue. I also noticed that the latest release of the packer plugin allows building templates off other templates, so I could extend cloud images if I had to if that worked.</p>
</section>
<section id="try-arch-with-packer" class="level1">
<h1>Try Arch with packer</h1>
<p>So I know how to build an Ubuntu image with packer (but it doesn’t have the settings I want) and I know how to build a template of Arch (but manually and without packer). Let’s see if I can combine that knowledge to build an Arch template with Packer. If I get that I’ll have pretty quick and repeatable ways of building templates for the main OSs I want templates of. I should be able to extend one or the other pattern to Debian as well. Let’s see how I can do with Arch. There’s not a ton of content for building Arch images with packer, but I did find <a href="https://github.com/elasticdog/packer-arch">this repo</a>. I’m not sure how closely I’m going to follow it since it’s a bunch of bash strung together. I think I’d like to try automating <a href="https://wiki.archlinux.org/title/Archinstall">archinstall</a> since that comes packaged with the installer now. If I can get my json together in the format it wants and copied onto the template machine it should be easy to do.</p>
<p>As a start I take the Ubuntu template and update it to point to Arch ISOs. I pick a random mirror in Canada for download. Normally I’d do torrents as they’re much faster, but I don’t feel like telling packer how to do torrents.</p>
<p>That’s going to take a while, so while it’s going let’s try and get a json template ready.</p>
<p>Ughh, my template installed version has no network connectivity. How am I even going to get the json out of it?</p>
</section>
<section id="give-it-a-shot-with-cloud-images" class="level1">
<h1>Give it a shot with cloud images</h1>
<p>While I was messing around with this, the <a href="https://github.com/ddelnano/packer-plugin-xenserver/releases/tag/v0.6.0">packer plugin</a> I’m using got a new release that claims to fix the XVA template builder. At least for Ubuntu this might mean that I can automate the building of cloud images to include guest-utils etc. For Arch I might still be hosed though, depends on if I can properly convert images to a raw format.</p>
<section id="xo-cli-problems" class="level2">
<h2 class="anchored" data-anchor-id="xo-cli-problems">XO-CLI problems</h2>
<p>To fully automate this there’s a few steps I have to do in advance outside of packer anyway, and honestly if I get them working I might be close enough that I just call it there. At this point I need node and some packages to <code>npm</code> install so we’re going to take a detour on a detour (on a…) and set up a devcontainer for this. Eventually if I get this going the way I like I’ll add it into my IaC devcontainer, but for now we’ll just do the basics. Packer install into the devcontainer goes ok. Figuring out the right way to get <code>npm</code> installed is always a bit of a pain, I just don’t use it enough to remember how I did it last time. Finally got <code>xo-cli</code> installed, but for the life of me I can’t figure out <code>xo-ova-upload</code>, which was going to be how I did the Ubuntu images. I guess we’ll try and be consistent on <code>qcow2</code> format images for everything.</p>
<p>After a lot of messing around with my dockerfile I have a devcontainer with <code>xo-cli</code>, <code>packer</code>, and <code>qemu-utils</code> installed.</p>
<p>First I download the qcow2 version of Ubuntu 20.04LTS, and then use <code>qemu-img</code> to convert it to <code>vhd</code> format.</p>
<p>I log into my XO vm with <code>xo-cli</code>, now I have to figure out how to import this VHD, attach it to a VM, and make it a template. Easy, right? Upon closer inspection the <code>xo-cli</code> does not have an option to import a disk.</p>
</section>
</section>
<section id="start-fresh" class="level1">
<h1>Start fresh</h1>
<p>Ok, we’re just going to solve this piece by piece, systematically. No more jumping around, we’re going to solve things one at a time (he said with great hubris before almost certainly heading down another rabbit hole). I’m going to focus on Ubuntu since I almost had that working before.</p>
<p>Do a re-run, it takes half an hour but finishes. Let’s make a machine.</p>
<p>We’re going to start with just the ssh key option for cloud config. As usual give it 20GB to make sure it’s resizing disks. Ok, it created but it’s still got the <code>testuser</code> user, the disk didn’t resize, and basically nothing about cloud init worked. Let’s see if I can upload the xva and do some post install stuff to fix that.</p>
<section id="first-hurdle-no-cloud-init" class="level2">
<h2 class="anchored" data-anchor-id="first-hurdle-no-cloud-init">First hurdle, no cloud-init</h2>
<p>Packer keeps an XVA of the image locally, so I upload that to XO. Ok, that becomes a template by default so I’m not sure if that’s what I want. Let’s make a new VM from it and try messing around there. Make a new VM, don’t bother adding cloud configs or resizing disk since we know it won’t work.</p>
<p>From within the booted machine I run <code>cloud-id</code> to figure out what cloud it thinks it’s in. I get back <code>none</code> where I want <code>NoCloud</code>. Taking a look at the <a href="https://canonical-cloud-init.readthedocs-hosted.com/en/latest/howto/identify_datasource.html">cloud-init docs</a> I run <code>sudo DEBUG_LEVEL=2 DI_LOG=stderr /usr/lib/cloud-init/ds-identify --force</code> to see what all I can see. There’s a data source list in there that includes <code>NoCloud</code> so I guess my idea from earlier that I had to force that into it somehow was a dead end anyway. The fact that it’s not detecting a cloud source at this stage might just be because I’m booting it as a regular VM though.</p>
</section>
<section id="try-manual" class="level2">
<h2 class="anchored" data-anchor-id="try-manual">Try manual</h2>
<p>At this point I am building a template, but it’s just not accepting cloud init configs, at least it doesn’t seem to be. Let’s try manually building an image and see if I can get it set up with cloud init, maybe that will give me some clues about doing it properly with packer.</p>
<p>I’ve already got the ISO uploaded to my storage repository thanks to packer, so I create a new VM with that ISO attached.</p>
<ul>
<li><p>select my language</p></li>
<li><p>have it update the installer</p></li>
<li><p>standard keyboard layout</p></li>
<li><p>pick just Ubuntu server without third party drivers</p></li>
<li><p>standard dhcp</p></li>
<li><p>no proxy</p></li>
<li><p>default mirror</p></li>
<li><p>custom storage layout, have to make sure the main partition is at the end so it can grow</p></li>
<li><p>just make one flat ext4 partition on the image</p></li>
<li><p>Make a user <code>testuser</code> and give them the password <code>ubuntu</code> (will have to make sure this gets wiped)</p></li>
<li><p>skip Ubuntu pro</p></li>
<li><p>Install ssh server, don’t import keys, allow password auth</p></li>
<li><p>No featured server snaps</p></li>
<li><p>Hit reboot</p></li>
<li><p>have trouble unmounting the CD so unmount it from XO and then reboot</p></li>
<li><p>reboot - cloud init ran, although there was no config</p></li>
<li><p><code>sudo apt update &amp;&amp; sudo apt upgrade -y</code></p></li>
<li><p><code>sudo apt install xe-guest-utilities -y</code> guest agent is detected on host and I can see network</p></li>
<li><p><code>sudo apt install cloud-initramfs-growroot -y</code> we’ll see if this works after template creation</p></li>
<li><p><code>systemctl status cloud-init</code> it’s running</p></li>
<li><p><code>sudo cloud-init clean</code> remove the cache, running without <code>sudo</code> fails</p></li>
<li><p><code>sudo poweroff</code></p></li>
<li><p>Back in XO convert to template</p></li>
<li><p>Create a new VM from the template, use my cloudconfig that I had working with Arch</p></li>
<li><p>Give it 15G of disk to see if it will grow</p></li>
</ul>
<p>It partially worked. It got a new hostname, and the disk grew, but the <code>testuser</code> user was still there. I could ssh in as the new user I made though with my ssh key. So that’s pretty good. Maybe there’s something I can add to the cloud config to remove the test user.</p>
<p>According to my friend ChatGPT, I can add this line to my cloud-init to clean it out:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">runcmd</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="kw">[</span><span class="at">userdel</span><span class="kw">,</span><span class="at"> -r</span><span class="kw">,</span><span class="at"> olduser</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Feels like there should be a better way to do this, but let’s at least try it first. It works! Ok, that’s pretty neat. From a little more reading around it seems like the trick is to either delete that user or set their shell to <code>nologin</code> or something. I think deleting is fine for my purposes, as long as I’m consistent with that cloud config.</p>
</section>
<section id="run-packer-again" class="level2">
<h2 class="anchored" data-anchor-id="run-packer-again">Run packer again</h2>
<p>There’s really not a lot I’ve done differently (that I can tell) between my packer auto install and the manual one. Maybe running <code>cloud-init clean</code> was required? I could see packer not automagically doing that and it causing a problem. To do that properly I needed <code>sudo</code> so I have to try and modify my autoinstall block to give <code>testuser</code> passwordless sudo, and then put a shell block at the end of the provisionder to run <code>sudo cloud-init clean</code>. It’s worth a shot.</p>
<p>Got most of the way through but it didn’t like my <code>sudo</code> command. After some looking around I found another packer script that had <code>sudo -S -E bash</code> in it and that seemed to work so let’s give it another run with that. Nope, failed on the password prompt</p>
<p>Ok, I found <a href="https://github.com/shantanoo-desai/packer-ubuntu-server-uefi">this post</a> that has a slightly different setup. Let’s give it a shot. This is definitely getting ridiculous. I got the manual prompt during build this time for the first time in a while. I just typed it in from the console to continue, not sure if it’s something I changed or just a coincidence. It’s showed up and disappeared without any code changes before.</p>
<p>Well, something I did this time made it so that I couldn’t ssh in, which made the installer hang.</p>
</section>
</section>
<section id="give-up" class="level1">
<h1>Give up</h1>
<p>I’ve sunk so much time into this it’s ridiculous. I can just build a few templates, document what I did and be done with it. I guess I learned a bit about cloud-init so that’s good? Wow.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/blog\.ianpreston\.ca");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>