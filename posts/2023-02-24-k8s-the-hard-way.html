<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-02-24">
<meta name="description" content="I may have bit off a bit more than I could chew">

<title>Ian’s blog - Notes on Kubernetes the hard way</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ian’s blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ianepreston" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Notes on Kubernetes the hard way</h1>
                  <div>
        <div class="description">
          I may have bit off a bit more than I could chew
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">kubernetes</div>
                <div class="quarto-category">proxmox</div>
                <div class="quarto-category">Linux</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 24, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#provisioning-compute" id="toc-provisioning-compute" class="nav-link" data-scroll-target="#provisioning-compute">Provisioning compute</a>
  <ul class="collapse">
  <li><a href="#sidebar-to-load-in-secrets" id="toc-sidebar-to-load-in-secrets" class="nav-link" data-scroll-target="#sidebar-to-load-in-secrets">Sidebar to load in secrets</a></li>
  <li><a href="#basic-setup" id="toc-basic-setup" class="nav-link" data-scroll-target="#basic-setup">Basic setup</a></li>
  <li><a href="#provision-vms" id="toc-provision-vms" class="nav-link" data-scroll-target="#provision-vms">Provision VMs</a>
  <ul class="collapse">
  <li><a href="#create-a-module" id="toc-create-a-module" class="nav-link" data-scroll-target="#create-a-module">Create a module</a></li>
  <li><a href="#fun-with-loops" id="toc-fun-with-loops" class="nav-link" data-scroll-target="#fun-with-loops">Fun with loops</a></li>
  </ul></li>
  <li><a href="#put-it-all-together" id="toc-put-it-all-together" class="nav-link" data-scroll-target="#put-it-all-together">Put it all together</a></li>
  </ul></li>
  <li><a href="#generating-config" id="toc-generating-config" class="nav-link" data-scroll-target="#generating-config">Generating config</a>
  <ul class="collapse">
  <li><a href="#provisioning-a-ca-and-generating-tls-certificates" id="toc-provisioning-a-ca-and-generating-tls-certificates" class="nav-link" data-scroll-target="#provisioning-a-ca-and-generating-tls-certificates">Provisioning a CA and Generating TLS certificates</a></li>
  <li><a href="#generating-kubernetes-configuration-files-for-authentication" id="toc-generating-kubernetes-configuration-files-for-authentication" class="nav-link" data-scroll-target="#generating-kubernetes-configuration-files-for-authentication">Generating Kubernetes configuration files for authentication</a></li>
  <li><a href="#generating-the-data-encryption-config-and-key" id="toc-generating-the-data-encryption-config-and-key" class="nav-link" data-scroll-target="#generating-the-data-encryption-config-and-key">Generating the data encryption config and key</a></li>
  </ul></li>
  <li><a href="#bootstrap-the-etcd-cluster" id="toc-bootstrap-the-etcd-cluster" class="nav-link" data-scroll-target="#bootstrap-the-etcd-cluster">Bootstrap the etcd cluster</a></li>
  <li><a href="#bootstrap-the-kubernetes-control-plane" id="toc-bootstrap-the-kubernetes-control-plane" class="nav-link" data-scroll-target="#bootstrap-the-kubernetes-control-plane">Bootstrap the kubernetes control plane</a>
  <ul class="collapse">
  <li><a href="#rbac-for-the-kubelet-authorization" id="toc-rbac-for-the-kubelet-authorization" class="nav-link" data-scroll-target="#rbac-for-the-kubelet-authorization">RBAC for the kubelet authorization</a></li>
  <li><a href="#front-end-load-balancer" id="toc-front-end-load-balancer" class="nav-link" data-scroll-target="#front-end-load-balancer">Front end load balancer</a></li>
  </ul></li>
  <li><a href="#bootstrapping-the-kubernetes-worker-nodes" id="toc-bootstrapping-the-kubernetes-worker-nodes" class="nav-link" data-scroll-target="#bootstrapping-the-kubernetes-worker-nodes">Bootstrapping the kubernetes worker nodes</a></li>
  <li><a href="#configuring-kubectl-for-remote-access" id="toc-configuring-kubectl-for-remote-access" class="nav-link" data-scroll-target="#configuring-kubectl-for-remote-access">Configuring kubectl for remote access</a></li>
  <li><a href="#provisioning-pod-network-routes" id="toc-provisioning-pod-network-routes" class="nav-link" data-scroll-target="#provisioning-pod-network-routes">Provisioning pod network routes</a></li>
  <li><a href="#deploying-the-dns-cluster-add-on" id="toc-deploying-the-dns-cluster-add-on" class="nav-link" data-scroll-target="#deploying-the-dns-cluster-add-on">Deploying the DNS cluster add-on</a></li>
  <li><a href="#call-it-quits" id="toc-call-it-quits" class="nav-link" data-scroll-target="#call-it-quits">Call it quits</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this post I’ll be recording notes related to working through <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">kubernetes the hard way</a> by Kelsey Hightower. I’ve gone through a few kubernetes tutorials before, and messed around with <a href="https://minikube.sigs.k8s.io/docs/">minikube</a> a bit, but that’s it. Before I try and get a “proper” k8s cluster going on my proxmox setup I’m going to try and work through this guide in the hope that it will improve my understanding of the setup.</p>
</section>
<section id="provisioning-compute" class="level1">
<h1>Provisioning compute</h1>
<p>All the terraform code for the provisioning can be found <a href="https://github.com/ianepreston/scratch/tree/main/k8s-the-hard-way/pve-terraform">here</a>.</p>
<p>Almost immediately I’m deviating from the guide because it expects me to deploy things in google cloud, and instead I’m going to do it on my local network. I don’t expect this to cause me a ton of problems, except I won’t have access to an external cloud load balancer, so I’ll have to figure something else out there. I’ll cross that bridge when I get to it.</p>
<p>Additionally, I also can’t provision the VMs the guide recommends using the gcs specific commands, instead I’ll use terraform to provision VMs from the templates I set up in <a href="../posts/2023-01-21-proxmox3.html">an earlier post</a>.</p>
<section id="sidebar-to-load-in-secrets" class="level2">
<h2 class="anchored" data-anchor-id="sidebar-to-load-in-secrets">Sidebar to load in secrets</h2>
<p>Terraform needs credentials to control my proxmox cluster, and I clearly don’t want to have those in git. In my earlier post I mentioned that I’d try using vault or bitwarden to manage secrets at some point. I’m going to save vault for now, but I have added the <a href="https://bitwarden.com/help/cli/">bitwarden cli</a> to my devcontainer, so I should be able to use it to securely retrieve credentials into a project. I created a secure note in bitwarden labeled <code>pve_terraform_cred</code>, now to load that into my workspace.</p>
<p>This actually turned out to be pretty straightforward, which was a nice surprise:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-f</span> pve_creds.env <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Credentials file doesn't already exist, loading from Bitwarden."</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Logging into bitwarden"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">bw</span> login</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Getting the terraform creds"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">bw</span> get notes pve_terraform_cred <span class="op">&gt;</span> pve_creds.env</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now when I start working in terraform I just have to run <code>source pve_creds.env</code> in my terminal to have the environment variables for my username and password available. I spent a bit of time trying to get the script itself to set the environment variables, but child processes can’t modify the environment of their parents so I’m stuck there.</p>
</section>
<section id="basic-setup" class="level2">
<h2 class="anchored" data-anchor-id="basic-setup">Basic setup</h2>
<p>I covered this in the templates post, but briefly let’s go over setting up the provider and a connection to my cluster. In my <code>main.tf</code> file I have the following code:</p>
<pre class="tf"><code>terraform {
  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = "2.9.11"
    }
  }
}
provider "proxmox" {
  pm_tls_insecure = true
  pm_api_url      = "https://pve1.local.ipreston.net:8006/api2/json"
}</code></pre>
<p>And that’s it for setting up the connection. I have environment variables set by my script above with the username and password to my cluster so I don’t need to provide anything in the code. A quick <code>terraform init</code> followed by <code>terraform plan</code> shows that I’m all set up.</p>
</section>
<section id="provision-vms" class="level2">
<h2 class="anchored" data-anchor-id="provision-vms">Provision VMs</h2>
<p>To follow the guide I will need to create a total of 6 VMs, 3 each of controllers and workers. The configuration of all of these nodes should be largely identical, with the exception of hostname, IP address, and which proxmox node they’re loaded on. The most straightforward way to do this in terraform would be to just set up one VM, and then copy-paste its config 5 more times with slight modifications. I could do a slightly fancier version with <a href="https://developer.hashicorp.com/terraform/language/meta-arguments/for_each">for each loops</a>, but that will still have a lot of common config mixed in with the parts that are looping and will be tricky to read and update. It’s a bit overkill for something like this, but the point here is learning so I’m going to create a <a href="https://developer.hashicorp.com/terraform/tutorials/modules/module-create">module</a> that hard codes all the common aspects of the VMs I’m going to create and only leaves the parts that will change across nodes and controlllers/workers as variables.</p>
<section id="create-a-module" class="level3">
<h3 class="anchored" data-anchor-id="create-a-module">Create a module</h3>
<p>In the terraform folder I’ll make a <code>modules/ubuntu-vm</code> subdirectory and in that I’ll place two files. First we have <code>variables.tf</code>:</p>
<pre class="tf"><code>variable "node" {
  description = "Proxmox node number to deploy to"
  type        = number
}

variable "type" {
  description = "A controller or worker node"
  type        = string
}

variable "ip" {
  description = "The static IP for the VM"
  type        = string
}</code></pre>
<p>This is just defining the variables that I’ll need to pass into this module to create a resource. As described above, I want everything else about these nodes to be the same, so this is all I need for variables.</p>
<p>Then I have a <code>main.tf</code>:</p>
<pre class="tf"><code>terraform {
  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = "2.9.11"
    }
  }
}

resource "proxmox_vm_qemu" "ubuntu-vm" {
  name        = "ubuntu-${var.type}-${var.node}"
  target_node = "pve${var.node}"
  onboot      = true
  oncreate    = true
  clone       = "ubuntujammytemplate"
  full_clone  = true
  agent       = 1
  os_type     = "cloud-init"
  cores       = 4
  cpu         = "host"
  memory      = 8192
  bootdisk    = "scsi0"
  disk {
    slot     = 0
    size     = "100G"
    type     = "scsi"
    storage  = "local-zfs"
    iothread = 1
  }
  network {
    model  = "virtio"
    bridge = "vmbr0"
  }
  ipconfig0 = "ip=${var.ip}/24,gw=192.168.85.1"
}</code></pre>
<p>Having to put the required provider up here was a little confusing at first, since I had it defined in the base terraform module, but after some errors and troubleshooting I learned that I have to specify the required provider in every module that uses it. Note that I don’t have the <code>provider</code> block that explicitly points to the actual proxmox instance I want to apply this to, that only lives in the base module. The rest of this block is a standard <a href="https://registry.terraform.io/providers/Telmate/proxmox/latest/docs/resources/vm_qemu">terraform proxmox VM</a> resource where I’ve hard coded in all the parameters I want to be consistent across nodes, and plugged in variables for the parts that are going to change.</p>
</section>
<section id="fun-with-loops" class="level3">
<h3 class="anchored" data-anchor-id="fun-with-loops">Fun with loops</h3>
<p>The other tricky part of this is that I would really like to do nested for each loops, which I guess isn’t a native concept in terraform. In python to create the map of values that I want I’d do something like:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>vms <span class="op">=</span> [</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nodetype"</span>: nodetype,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pvenode"</span>: i <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vm_ip"</span>: <span class="ss">f"192.168.85.</span><span class="sc">{</span><span class="dv">70</span> <span class="op">+</span> base_octet <span class="op">+</span> i<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> nodetype, base_octet <span class="kw">in</span> [(<span class="st">"controller"</span>, <span class="dv">0</span>), (<span class="st">"worker"</span>, <span class="dv">3</span>)]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I can’t nest a for each in terraform, so I have to do some nested for loops in variables to create a map that I can then use for each on. <a href="https://faultbucket.ca/2020/09/terraform-nested-for_each-example/">This blog</a> has basically the same issue so I should be able to follow its logic to produce what I want. After some fiddling around I get the following:</p>
<pre class="tf"><code>locals {
  nodetypes = {
    "controller" = 0
    "worker"     = 3
  }
  vm_attrs_list = flatten([
    for nodetype, baseoctet in local.nodetypes : [
      for i in range(3) : {
        name = "${nodetype}${i}"
        node = "${i + 1}",
        type = "${nodetype}",
        ip   = "192.168.85.${70 + baseoctet + i}"
      }
    ]
  ])
  vm_attrs_map = {
    for obj in local.vm_attrs_list : "${obj.name}" =&gt; obj
  }

}</code></pre>
<p>Which is certainly a lot more verbose than python, but whatever. I can check it out before trying to apply it to a resource by using <code>terraform console</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> terraform console</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> local.vm_attrs_map</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"controller0"</span> = {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ip"</span> = <span class="st">"192.168.85.70"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span> = <span class="st">"controller0"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"node"</span> = 1</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span> = <span class="st">"controller"</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"controller1"</span> = {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ip"</span> = <span class="st">"192.168.85.71"</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span> = <span class="st">"controller1"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"node"</span> = 2</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span> = <span class="st">"controller"</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"controller2"</span> = {</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ip"</span> = <span class="st">"192.168.85.72"</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span> = <span class="st">"controller2"</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"node"</span> = 3</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span> = <span class="st">"controller"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"worker0"</span> = {</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ip"</span> = <span class="st">"192.168.85.73"</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span> = <span class="st">"worker0"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"node"</span> = 1</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span> = <span class="st">"worker"</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"worker1"</span> = {</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ip"</span> = <span class="st">"192.168.85.74"</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span> = <span class="st">"worker1"</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"node"</span> = 2</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span> = <span class="st">"worker"</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"worker2"</span> = {</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ip"</span> = <span class="st">"192.168.85.75"</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span> = <span class="st">"worker2"</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"node"</span> = 3</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span> = <span class="st">"worker"</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="put-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="put-it-all-together">Put it all together</h2>
<p>Now that I’ve got my module created and my map to loop over I can finish up in <code>main.tf</code> in the root of this project:</p>
<pre class="tf"><code>module "ubuntu_vm" {
  source   = "./modules/ubuntu-vm"
  for_each = local.vm_attrs_map
  node     = each.value.node
  type     = each.value.type
  ip       = each.value.ip
}</code></pre>
<p>Nice and easy! I run <code>terraform init</code> again so that the module I created is loaded, then <code>terraform plan</code> to make sure I’m actually getting the 6 nodes I expect. Everything looks good so I run <code>terraform apply</code>… and wait an hour and a half for it to not actually deploy any nodes. When I initially tested terraform back when I was doing templates I did notice that it took a lot longer to deploy via terraform than via the menu, but that was minutes, not hours. Time to figure out what’s going on here.</p>
<p>As a fun aside to remember for later, as part of troubleshooting I tried updating the proxmox provider from the <code>2.9.11</code> version I was using to the <code>2.9.13</code> release and it just straight up doesn’t work. Everything installs ok but then I get:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> terraform plan</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">╷</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span> Error: Plugin did not respond</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   with provider<span class="pp">[</span><span class="st">"registry.terraform.io/telmate/proxmox"</span><span class="pp">]</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   on main.tf line 9, in provider <span class="st">"proxmox"</span>:</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>    9: provider <span class="st">"proxmox"</span> {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span> </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span> The plugin encountered an error, and failed to respond to the plugin.<span class="er">(</span><span class="ex">*GRPCProvider</span><span class="kw">)</span><span class="ex">.ConfigureProvider</span> call. The plugin</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span> logs may contain more details.</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="ex">╵</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When I revert back to the old release I can at least run <code>terraform plan</code>. There are quite a few threads about how the proxmox provider for terraform is kind of buggy and I’m starting to wonder if ansible would be a better way to go. I like the ability of terraform to tear down infrastructure with <code>terraform destroy</code> but I’m not sure it’s worth all this other hassle. I’ll keep messing with it for a bit though.</p>
<p>I found an <a href="https://github.com/Telmate/terraform-provider-proxmox/issues/325">open issue</a> on the proxmox terraform provider about slow provisioning. There’s also <a href="https://github.com/Telmate/terraform-provider-proxmox/issues/705">this one</a> about issues deploying multiple VMs. Both are still open but there were some suggested config changes, along with a recommendation to run in debug. Let’s try that with <code>TF_LOG=DEBUG terraform apply --auto-approve</code>. This dumped a giant stream of output, most of which I will not reproduce. One thing that caught my eye was that it couldn’t find the template VM I wanted to use. Looking back at my code I realized that I had missed the dashes in the template name. That’s definitely on me, although I’m going to put some blame on the provider for just hanging forever instead of returning an error.</p>
<p>After fixing the template the playbook applied and I had 6 VMs up and running, two on each node. It took a couple minutes to apply, but that’s not bad at all. Problem solved?</p>
<p>Almost. The newly deployed VMs are up and running, and I can ssh into them at their IPs, but they don’t have qemu guest agents running so I can’t see their IPs from the proxmox UI, or load up a terminal session from there. This isn’t the end of the world, but I’d like to fix it if I can. I think the problem is that I had <code>agent</code> turned off in the proxmox config as part of troubleshooting the slow deploy. Let’s see if I can fix that. This will also give me a chance to confirm that <code>terraform destroy</code> works. The destroy worked no problem. Setting <code>agent = 1</code> back in the template config worked fine in terms of creating the VM (no slowdown in deploy), but I still couldn’t load them from the proxmox UI. I created a manual clone of the same template to see if I could figure out the issue there. This one did show me the configured IP, but still wouldn’t let me open a console. After some more troubleshooting I realized this was because <a href="https://github.com/ianepreston/recipes/commit/a98994320b20d00e4b702aaf7aa9b3357039a07b#diff-8ea9f6ece084ec63cd3ec7c27a9cc2b4d1638be05824823990187a97dad99767">some changes</a> I’d made to my proxmox ssh host keys were blocking me from bringing up terminal sessions on any hosts other than the one I was connecting to the UI through. Again, that’s totally my bad, although I could have gone for some better error messages.</p>
</section>
</section>
<section id="generating-config" class="level1">
<h1>Generating config</h1>
<p>All the ansible playbooks and configs for the sections below can be found <a href="https://github.com/ianepreston/scratch/tree/main/k8s-the-hard-way/ansible">here</a>.</p>
<section id="provisioning-a-ca-and-generating-tls-certificates" class="level2">
<h2 class="anchored" data-anchor-id="provisioning-a-ca-and-generating-tls-certificates">Provisioning a CA and Generating TLS certificates</h2>
<p><a href="https://github.com/ianepreston/scratch/blob/main/k8s-the-hard-way/ansible/01_ca_certs.yml">Ansible playbook</a></p>
<p>On to <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/04-certificate-authority.md">chapter 4</a> in the guide!</p>
<p>I have to do some minor modification of the scripts outlined in the doc since I’m not using GCP. I think for these future configs I’m going to use ansible, since that’s how I’d like to actually manage hosts in the future.</p>
<p>The first big headache I ran into was getting <code>cfssl</code> installed to generate the certs. It didn’t have a <code>.deb</code> available that I could find so I had to install <code>go</code> and then install the package there, as well as figuring out how to make the path to the binary it installed available to my user (learned a couple things about <code>GOPATH</code> in the process).</p>
<p>Other than that creating all the keys and copying them onto the hosts was pretty straightforward ansible. I’ll have to wait until later to see if anything broke, but for now it seems good.</p>
</section>
<section id="generating-kubernetes-configuration-files-for-authentication" class="level2">
<h2 class="anchored" data-anchor-id="generating-kubernetes-configuration-files-for-authentication">Generating Kubernetes configuration files for authentication</h2>
<p><a href="https://github.com/ianepreston/scratch/blob/main/k8s-the-hard-way/ansible/02_kube_config.yml">Ansible playbook</a></p>
<p>On to the next thing! This section uses <code>kubectl</code>, which I fortunately already have available in my devcontainer, so no config required there. I’ll keep going with my pattern of using ansible to manage the scripting. No issues with any of these steps, at least not at this point. I might have to come back to some of it for troubleshooting.</p>
</section>
<section id="generating-the-data-encryption-config-and-key" class="level2">
<h2 class="anchored" data-anchor-id="generating-the-data-encryption-config-and-key">Generating the data encryption config and key</h2>
<p><a href="https://github.com/ianepreston/scratch/blob/main/k8s-the-hard-way/ansible/03_encryption.yml">Ansible playbook</a></p>
<p>Same as the above. I did a slightly different workflow for the ansible playbook. Since this called for generating a random number as part of the config, rather than doing something fancy like registering the output of a command to generate the random number and then inserting that into a template I just wrapped the whole thing in a shell command.</p>
</section>
</section>
<section id="bootstrap-the-etcd-cluster" class="level1">
<h1>Bootstrap the etcd cluster</h1>
<p><a href="https://github.com/ianepreston/scratch/blob/main/k8s-the-hard-way/ansible/04_bootstrap_etcd.yml">Ansible playbook</a></p>
<p>On to <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/07-bootstrapping-etcd.md">chapter 7</a> Now we’re getting into interesting stuff where I’m actually starting services on the nodes. The instructions for this part are fairly imperative so I’ll actually have to do some modification to make them work properly with ansible, for instance using <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html">get_url</a> instead of invoking <code>wget</code> to grab the <code>etcd</code> binary. Actually upon further reading I can just use the <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/unarchive_module.html">unarchive</a> module to download and extract the archive, neat!</p>
<p>This all seemed to be going well until I actually had to start the etcd service and hit an error:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> systemctl status etcd.service</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">●</span> etcd.service <span class="at">-</span> etcd</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Loaded:</span> loaded <span class="er">(</span><span class="ex">/etc/systemd/system/etcd.service</span><span class="kw">;</span> <span class="ex">enabled</span><span class="kw">;</span> <span class="ex">vendor</span> preset: enabled<span class="kw">)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Active:</span> activating <span class="er">(</span><span class="ex">auto-restart</span><span class="kw">)</span> <span class="kw">(</span><span class="ex">Result:</span> exit-code<span class="kw">)</span> <span class="ex">since</span> Sat 2023-03-04 23:55:47 UTC<span class="kw">;</span> <span class="ex">3s</span> ago</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Docs:</span> https://github.com/coreos</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Process:</span> 13038 ExecStart=/usr/local/bin/etcd <span class="dt">\ </span><span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>203/EXEC<span class="kw">)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Main</span> PID: 13038 <span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>203/EXEC<span class="kw">)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CPU:</span> 1ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ok, looks like when I copied the <code>etcd</code> binaries into <code>/usr/local/bin</code> they lost their execute permission. Adding <code>mode: '0700'</code> to the copy task in ansible seems to fix that, but now I have a new failure:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> systemctl status etcd.service</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">●</span> etcd.service <span class="at">-</span> etcd</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Loaded:</span> loaded <span class="er">(</span><span class="ex">/etc/systemd/system/etcd.service</span><span class="kw">;</span> <span class="ex">enabled</span><span class="kw">;</span> <span class="ex">vendor</span> preset: enabled<span class="kw">)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Active:</span> activating <span class="er">(</span><span class="ex">auto-restart</span><span class="kw">)</span> <span class="kw">(</span><span class="ex">Result:</span> exit-code<span class="kw">)</span> <span class="ex">since</span> Sun 2023-03-05 00:00:09 UTC<span class="kw">;</span> <span class="ex">3s</span> ago</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Docs:</span> https://github.com/coreos</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Process:</span> 13571 ExecStart=/usr/local/bin/etcd <span class="dt">\ </span><span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>1/FAILURE<span class="kw">)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Main</span> PID: 13571 <span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>1/FAILURE<span class="kw">)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CPU:</span> 13ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Running <code>journalctl -xeu etcd.service</code> I think the pertinent line is:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:02:26 ubuntu-controller-1 etcd<span class="pp">[</span><span class="ss">13841</span><span class="pp">]</span>: error verifying flags, <span class="st">'\'</span> is not a valid flag. See <span class="st">'etcd --help'</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’m able to run the <code>etcd</code> binary manually, so my best guess is something in my service definition is wrong.</p>
<p>Two problems came up after looking at the output of the template. First I had to change my variable to get the host IP address from <code>{{ ansible_default_ipv4 }}</code> to <code>{{ ansible_default_ipv4.address }}</code> to just get the IP address instead of a big dictionary of everything about the network connection. Next I think the code I copied from the guide had <code>\\</code> after every line break to escape the <code>\</code> character because it was being piped through <code>tee</code> in the example. Since I’m not doing that I swapped to just a <code>\</code>.</p>
<p>This seems to have cleaned up the service definition, but I’m still having a failure.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> systemctl status etcd.service</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">●</span> etcd.service <span class="at">-</span> etcd</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Loaded:</span> loaded <span class="er">(</span><span class="ex">/etc/systemd/system/etcd.service</span><span class="kw">;</span> <span class="ex">enabled</span><span class="kw">;</span> <span class="ex">vendor</span> preset: enabled<span class="kw">)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Active:</span> activating <span class="er">(</span><span class="ex">auto-restart</span><span class="kw">)</span> <span class="kw">(</span><span class="ex">Result:</span> exit-code<span class="kw">)</span> <span class="ex">since</span> Sun 2023-03-05 00:14:59 UTC<span class="kw">;</span> <span class="ex">1s</span> ago</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Docs:</span> https://github.com/coreos</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Process:</span> 15563 ExecStart=/usr/local/bin/etcd <span class="at">--name</span> ubuntu-controller-1 <span class="at">--cert-file</span><span class="op">=</span>/etc/etcd/kuber<span class="op">&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Main</span> PID: 15563 <span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>1/FAILURE<span class="kw">)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CPU:</span> 15ms</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:14:59 ubuntu-controller-1 systemd<span class="pp">[</span><span class="ss">1</span><span class="pp">]</span>: etcd.service: Failed with result <span class="st">'exit-code'</span>.</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:14:59 ubuntu-controller-1 systemd<span class="pp">[</span><span class="ss">1</span><span class="pp">]</span>: Failed to start etcd.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Looking at journalctl again it looks like my error is <code>Mar 05 00:15:09 ubuntu-controller-1 etcd[15585]: couldn't find local name "ubuntu-controller-1" in the initial cluster configuration</code>. Right, that’s because I didn’t update that part of the template from the hostnames used in the guide to the hostnames I gave my controllers. One more try.</p>
<p>Alright, now the service is started. Running the confirmation command from the guide I get an output that looks good:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> sudo ETCDCTL_API=3 etcdctl member list <span class="dt">\</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--endpoints</span><span class="op">=</span>https://127.0.0.1:2379 <span class="dt">\c</span>d-v3.4.15-linux-amd64$</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--cacert=/etc/etcd/ca.pem</span> <span class="dt">\~</span>/etcd/etcd-v3.4.15-linux-amd64$</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--cert=/etc/etcd/kubernetes.pem</span> <span class="dt">\</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--key</span><span class="op">=</span>/etc/etcd/kubernetes-key.pem</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ex">7dceec040adbf023,</span> started, ubuntu-controller-2, https://192.168.85.71:2380, , false</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ex">ab94230b177e1d5c,</span> started, ubuntu-controller-1, https://192.168.85.70:2380, https://192.168.85.70:2379, false</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">e88d02db26fab5bc,</span> started, ubuntu-controller-3, https://192.168.85.72:2380, https://192.168.85.72:2379, false</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’m getting some concerning errors in the service status though:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> systemctl status etcd.service</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">●</span> etcd.service <span class="at">-</span> etcd</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Loaded:</span> loaded <span class="er">(</span><span class="ex">/etc/systemd/system/etcd.service</span><span class="kw">;</span> <span class="ex">enabled</span><span class="kw">;</span> <span class="ex">vendor</span> preset: enabled<span class="kw">)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Active:</span> active <span class="er">(</span><span class="ex">running</span><span class="kw">)</span> <span class="ex">since</span> Sun 2023-03-05 00:18:35 UTC<span class="kw">;</span> <span class="ex">3min</span> 29s ago</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Docs:</span> https://github.com/coreos</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Main</span> PID: 16361 <span class="er">(</span><span class="ex">etcd</span><span class="kw">)</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">Tasks:</span> 14 <span class="er">(</span><span class="ex">limit:</span> 9492<span class="kw">)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Memory:</span> 37.6M</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CPU:</span> 33.018s</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>     <span class="ex">CGroup:</span> /system.slice/etcd.service</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>             <span class="ex">└─16361</span> /usr/local/bin/etcd <span class="at">--name</span> ubuntu-controller-1 <span class="at">--cert-file</span><span class="op">=</span>/etc/etcd/kubernetes.pem <span class="at">--key-file</span><span class="op">=</span>/etc/etcd/kubernetes-key.pem <span class="at">--peer-cert-file</span><span class="op">=</span>/etc/etcd/kubernetes.pem <span class="at">--peer-key-file</span><span class="op">=</span>/etc/etcd/kubernetes-key.pem <span class="at">--trusted-ca-file</span><span class="op">=</span>/<span class="op">&gt;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:22:04 ubuntu-controller-1 etcd<span class="pp">[</span><span class="ss">16361</span><span class="pp">]</span>: rejected connection from <span class="st">"192.168.85.71:37770"</span> <span class="er">(</span><span class="ex">error</span> <span class="st">"tls: </span><span class="dt">\"</span><span class="st">192.168.85.71</span><span class="dt">\"</span><span class="st"> does not match any of DNSNames [</span><span class="dt">\"</span><span class="st">kubernetes</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc.cl&gt;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="st">Mar 05 00:22:04 ubuntu-controller-1 etcd[16361]: rejected connection from "</span>192.168.85.71:37780<span class="st">" (error "</span>tls: <span class="dt">\"</span>192.168.85.71<span class="dt">\"</span> does not match any of DNSNames [<span class="dt">\"</span>kubernetes<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc.cl<span class="op">&gt;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:22:05 ubuntu-controller-1 etcd<span class="pp">[</span><span class="ss">16361</span><span class="pp">]</span>: rejected connection from <span class="st">"192.168.85.71:37790"</span> <span class="er">(</span><span class="ex">error</span> <span class="st">"tls: </span><span class="dt">\"</span><span class="st">192.168.85.71</span><span class="dt">\"</span><span class="st"> does not match any of DNSNames [</span><span class="dt">\"</span><span class="st">kubernetes</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc.cl&gt;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="st">Mar 05 00:22:05 ubuntu-controller-1 etcd[16361]: rejected connection from "</span>192.168.85.71:37796<span class="st">" (error "</span>tls: <span class="dt">\"</span>192.168.85.71<span class="dt">\"</span> does not match any of DNSNames [<span class="dt">\"</span>kubernetes<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc.cl<span class="op">&gt;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:22:05 ubuntu-controller-1 etcd<span class="pp">[</span><span class="ss">16361</span><span class="pp">]</span>: health check for peer 7dceec040adbf023 could not connect: x509: certificate is valid for 192.168.85.70, 192.168.86.71, 192.168.85.72, 127.0.0.1, not 192.168.85.71</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:22:05 ubuntu-controller-1 etcd<span class="pp">[</span><span class="ss">16361</span><span class="pp">]</span>: health check for peer 7dceec040adbf023 could not connect: x509: certificate is valid for 192.168.85.70, 192.168.86.71, 192.168.85.72, 127.0.0.1, not 192.168.85.71</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:22:05 ubuntu-controller-1 etcd<span class="pp">[</span><span class="ss">16361</span><span class="pp">]</span>: rejected connection from <span class="st">"192.168.85.71:37806"</span> <span class="er">(</span><span class="ex">error</span> <span class="st">"tls: </span><span class="dt">\"</span><span class="st">192.168.85.71</span><span class="dt">\"</span><span class="st"> does not match any of DNSNames [</span><span class="dt">\"</span><span class="st">kubernetes</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc.cl&gt;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="st">Mar 05 00:22:05 ubuntu-controller-1 etcd[16361]: rejected connection from "</span>192.168.85.71:37818<span class="st">" (error "</span>tls: <span class="dt">\"</span>192.168.85.71<span class="dt">\"</span> does not match any of DNSNames [<span class="dt">\"</span>kubernetes<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc.cl<span class="op">&gt;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 05 00:22:05 ubuntu-controller-1 etcd<span class="pp">[</span><span class="ss">16361</span><span class="pp">]</span>: rejected connection from <span class="st">"192.168.85.71:37828"</span> <span class="er">(</span><span class="ex">error</span> <span class="st">"tls: </span><span class="dt">\"</span><span class="st">192.168.85.71</span><span class="dt">\"</span><span class="st"> does not match any of DNSNames [</span><span class="dt">\"</span><span class="st">kubernetes</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\"</span><span class="st">kubernetes.default.svc.cl&gt;</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="st">Mar 05 00:22:05 ubuntu-controller-1 etcd[16361]: rejected connection from "</span>192.168.85.71:37832<span class="st">" (error "</span>tls: <span class="dt">\"</span>192.168.85.71<span class="dt">\"</span> does not match any of DNSNames [<span class="dt">\"</span>kubernetes<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc<span class="dt">\"</span> <span class="dt">\"</span>kubernetes.default.svc.cl<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Right, right, that’s because I had a typo in the cert generation where I put <code>192.168.86.71</code> instead of <code>192.168.85.71</code>. Ok, fine. Fix that and try again.</p>
<p>Looks like it works! The service is up and running, the status is not beset with errors about not being able to talk. I think I’m good!</p>
</section>
<section id="bootstrap-the-kubernetes-control-plane" class="level1">
<h1>Bootstrap the kubernetes control plane</h1>
<p><a href="https://github.com/ianepreston/scratch/blob/main/k8s-the-hard-way/ansible/05_bootstrap_control_plane.yml">Ansible playbook</a></p>
<p>A lot of the activity in this section is similar to bootstrapping the etcd cluster from an ansible perspective. Download some files, copy some others over into various locations, start up some systemd units and off you go. I had very few issues getting this initially set up, except that I realized I’d missed copying over one config file in the CA certs section so I had to go back and update that playbook to fix that issue.</p>
<p>When it came time to verify the cluster status though I ran into an issue:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> sudo kubectl cluster-info <span class="at">--kubeconfig</span> admin.kubeconfig</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">To</span> further debug and diagnose cluster problems, use <span class="st">'kubectl cluster-info dump'</span>.</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> connection to the server 127.0.0.1:6443 was refused <span class="at">-</span> did you specify the right host or port<span class="pp">?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So now we’re in troubleshooting mode. First up, let’s check the status of the services I just started:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> systemctl status kube-apiserver</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">●</span> kube-apiserver.service <span class="at">-</span> Kubernetes API Server</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Loaded:</span> loaded <span class="er">(</span><span class="ex">/etc/systemd/system/kube-apiserver.service</span><span class="kw">;</span> <span class="ex">enabled</span><span class="kw">;</span> <span class="ex">vendor</span> preset: enabled<span class="kw">)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Active:</span> activating <span class="er">(</span><span class="ex">auto-restart</span><span class="kw">)</span> <span class="kw">(</span><span class="ex">Result:</span> exit-code<span class="kw">)</span> <span class="ex">since</span> Sun 2023-03-12 22:17:56 UTC<span class="kw">;</span> <span class="ex">2s</span> ago</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Docs:</span> https://github.com/kubernetes/kubernetes</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Process:</span> 19077 ExecStart=/usr/local/bin/kube-apiserver <span class="dt">\ </span><span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>1/FAILURE<span class="kw">)</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Main</span> PID: 19077 <span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>1/FAILURE<span class="kw">)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CPU:</span> 83ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ok, not off to a great start.</p>
<p>Back to my old friend <code>journalctl -xeu kube-apiserver</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Mar</span> 12 22:19:04 ubuntu-controller-1 kube-apiserver<span class="pp">[</span><span class="ss">19370</span><span class="pp">]</span>: Error: <span class="st">"kube-apiserver"</span> does not take any arguments, got <span class="pp">[</span><span class="st">"</span><span class="dt">\\</span><span class="st">"</span><span class="pp">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Oh right, this is that problem with templates again compared to how the GitHub page wants me to <code>cat</code> this stuff in.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> sudo kubectl cluster-info <span class="at">--kubeconfig</span> admin.kubeconfig</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Kubernetes</span> control plane is running at https://127.0.0.1:6443</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="ex">To</span> further debug and diagnose cluster problems, use <span class="st">'kubectl cluster-info dump'</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alright! At least that was an easy fix. Should have remembered it from last time, but oh well.</p>
<p>This section has some instructions for setting up a proxy to handle health checks from the load balancer, but I don’t have a load balancer at this point, so I’m going to skip it. I’ll have to figure out how to set all that up when I’m doing a proper cluster, but this is just for learning so I’ll skip it.</p>
<section id="rbac-for-the-kubelet-authorization" class="level2">
<h2 class="anchored" data-anchor-id="rbac-for-the-kubelet-authorization">RBAC for the kubelet authorization</h2>
<p>These commands I only have to run on one node, and I’m not sure how to easily make them idempotent with ansible. They’re making changes on my cluster, not creating files (at least that I know of), so I don’t know how to tell ansible not to re-run the commands. In theory running them multiple times shouldn’t really matter, so I’ll just do it manually anyway.</p>
</section>
<section id="front-end-load-balancer" class="level2">
<h2 class="anchored" data-anchor-id="front-end-load-balancer">Front end load balancer</h2>
<p>Again, I don’t actually have a load balancer (maybe that will be what I do in my next post). So I’ll skip this part.</p>
</section>
</section>
<section id="bootstrapping-the-kubernetes-worker-nodes" class="level1">
<h1>Bootstrapping the kubernetes worker nodes</h1>
<p><a href="https://github.com/ianepreston/scratch/blob/main/k8s-the-hard-way/ansible/06_bootstrap_workers.yml">Ansible playbook</a></p>
<p>This is the last major step in having a working cluster as far as I can tell. The first step is installing some system dependencies, which is no problem. The next step is making sure swap is off. I started looking into idempotent ways to ensure this wasn’t turned on, then decided to just check if it was in my VMs to begin with. Turns out I didn’t set them up with swap to begin with so I can just skip that part.</p>
<p>Next I’ve got a bunch of binaries to install. Some of them are gzipped tar files and some are straight binaries. In both cases I can refer back to what I did for setting up the controllers and etcd to build the playbook. All of this actually went quite smoothly. At the end of running the playbook it looks like I have three worker nodes in my cluster!</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> sudo kubectl get nodes <span class="at">--kubeconfig</span> admin.kubeconfig</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>              STATUS   ROLES    AGE     VERSION</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ubuntu-worker-1</span>   Ready    <span class="op">&lt;</span>none<span class="op">&gt;</span>   2m35s   v1.21.0</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ubuntu-worker-2</span>   Ready    <span class="op">&lt;</span>none<span class="op">&gt;</span>   2m35s   v1.21.0</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ubuntu-worker-3</span>   Ready    <span class="op">&lt;</span>none<span class="op">&gt;</span>   2m35s   v1.21.0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="configuring-kubectl-for-remote-access" class="level1">
<h1>Configuring kubectl for remote access</h1>
<p>Let’s try this on my devcontainer. Again, I should be pointing at a load balancer, but I don’t have one, so I’m not. From the <code>workspace_ansible</code> folder within my devcontainer that has all my credentials saved I run the commands in <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/10-configuring-kubectl.md">the guide</a></p>
<p>After setting the context I run <code>kubectl version</code> and get:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl version <span class="at">--output</span><span class="op">=</span>json</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"clientVersion"</span><span class="ex">:</span> {</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"major"</span><span class="ex">:</span> <span class="st">"1"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minor"</span><span class="ex">:</span> <span class="st">"26"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gitVersion"</span><span class="ex">:</span> <span class="st">"v1.26.1"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gitCommit"</span><span class="ex">:</span> <span class="st">"8f94681cd294aa8cfd3407b8191f6c70214973a4"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gitTreeState"</span><span class="ex">:</span> <span class="st">"clean"</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"buildDate"</span><span class="ex">:</span> <span class="st">"2023-01-18T15:58:16Z"</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"goVersion"</span><span class="ex">:</span> <span class="st">"go1.19.5"</span>,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"compiler"</span><span class="ex">:</span> <span class="st">"gc"</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"platform"</span><span class="ex">:</span> <span class="st">"linux/amd64"</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"kustomizeVersion"</span><span class="ex">:</span> <span class="st">"v4.5.7"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"serverVersion"</span><span class="ex">:</span> {</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"major"</span><span class="ex">:</span> <span class="st">"1"</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minor"</span><span class="ex">:</span> <span class="st">"21"</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gitVersion"</span><span class="ex">:</span> <span class="st">"v1.21.0"</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gitCommit"</span><span class="ex">:</span> <span class="st">"cb303e613a121a29364f75cc67d3d580833a7479"</span>,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gitTreeState"</span><span class="ex">:</span> <span class="st">"clean"</span>,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"buildDate"</span><span class="ex">:</span> <span class="st">"2021-04-08T16:25:06Z"</span>,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"goVersion"</span><span class="ex">:</span> <span class="st">"go1.16.1"</span>,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"compiler"</span><span class="ex">:</span> <span class="st">"gc"</span>,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"platform"</span><span class="ex">:</span> <span class="st">"linux/amd64"</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> version difference between client <span class="er">(</span><span class="ex">1.26</span><span class="kw">)</span> <span class="ex">and</span> server <span class="er">(</span><span class="ex">1.21</span><span class="kw">)</span> <span class="ex">exceeds</span> the supported minor version skew of +/-1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Most of this looks fine, the version skew is because I’m using old kubernetes based on the static guide on my server.</p>
<p><code>kubectl get nodes</code> returns my three worker nodes, so I’m set!</p>
</section>
<section id="provisioning-pod-network-routes" class="level1">
<h1>Provisioning pod network routes</h1>
<p>This appears to only matter if I’m in the cloud. I’m going to skip it.</p>
</section>
<section id="deploying-the-dns-cluster-add-on" class="level1">
<h1>Deploying the DNS cluster add-on</h1>
<p>I’m sure there are more DevOpsy ways to do these kubectl commands, with or without ansible, but I don’t feel like learning them as part of this exercise, so I’m just going to run these commands from my devcontainer and see how it goes:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl apply <span class="at">-f</span> https://storage.googleapis.com/kubernetes-the-hard-way/coredns-1.8.yaml</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">serviceaccount/coredns</span> created</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">clusterrole.rbac.authorization.k8s.io/system:coredns</span> created</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ex">clusterrolebinding.rbac.authorization.k8s.io/system:coredns</span> created</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ex">configmap/coredns</span> created</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ex">deployment.apps/coredns</span> created</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> Service <span class="st">"kube-dns"</span> is invalid: spec.clusterIPs: Invalid value: []string{<span class="st">"10.32.0.10"</span>}: failed to allocated ip:10.32.0.10 with error:provided IP is not in the valid range. The range of valid IPs is 192.168.85.0/24</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Right out the gate I get an error. Nice. I guess I’ll download and then modify this file. After downloading and modifying the IP to point to my cluster it seems to work:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl apply <span class="at">-f</span> coredns-1.8.yaml </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">serviceaccount/coredns</span> unchanged</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ex">clusterrole.rbac.authorization.k8s.io/system:coredns</span> unchanged</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ex">clusterrolebinding.rbac.authorization.k8s.io/system:coredns</span> unchanged</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">configmap/coredns</span> unchanged</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ex">deployment.apps/coredns</span> unchanged</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ex">service/kube-dns</span> created</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Except maybe it didn’t?</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl get pods <span class="at">-l</span> k8s-app=kube-dns <span class="at">-n</span> kube-system</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">No</span> resources found in kube-system namespace.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Jumping ahead let’s try and deploy the <code>busybox</code> pod just to see if I can get anything running:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl run busybox <span class="at">--image</span><span class="op">=</span>busybox:1.28 <span class="at">--command</span> <span class="at">--</span> sleep 3600</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Error</span> from server <span class="er">(</span><span class="ex">Forbidden</span><span class="kw">)</span><span class="bu">:</span> pods <span class="st">"busybox"</span> is forbidden: error looking up service account default/default: serviceaccount <span class="st">"default"</span> not found</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ok, do I have any service accounts?</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl get serviceAccounts</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">No</span> resources found in default namespace</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Guess not. What step did I miss? From <a href="https://stackoverflow.com/questions/33528398/why-dont-i-have-a-default-serviceaccount-on-kubernetes">this post</a> I should get this from the <code>kube-controller-manager</code> binary. Looking back I can see that I did at least attemp to install that program and set up a service for it. Let’s see check its status on one of my controller nodes:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipreston@ubuntu-controller-1:~$</span> systemctl status kube-controller-manager</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">●</span> kube-controller-manager.service <span class="at">-</span> Kubernetes Controller Manager</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Loaded:</span> loaded <span class="er">(</span><span class="ex">/etc/systemd/system/kube-controller-manager.service</span><span class="kw">;</span> <span class="ex">enabled</span><span class="kw">;</span> <span class="ex">vendor</span> preset: enabled<span class="kw">)</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">Active:</span> activating <span class="er">(</span><span class="ex">auto-restart</span><span class="kw">)</span> <span class="kw">(</span><span class="ex">Result:</span> exit-code<span class="kw">)</span> <span class="ex">since</span> Fri 2023-03-17 17:20:35 UTC<span class="kw">;</span> <span class="ex">127ms</span> ago</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Docs:</span> https://github.com/kubernetes/kubernetes</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Process:</span> 589315 ExecStart=/usr/local/bin/kube-controller-manager <span class="at">--bind-address</span><span class="op">=</span>0.0.0.0 <span class="at">--cluster-cidr</span><span class="op">=</span>192.168.85.0<span class="op">&gt;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Main</span> PID: 589315 <span class="er">(</span><span class="va">code</span><span class="op">=</span>exited, <span class="va">status</span><span class="op">=</span>1/FAILURE<span class="kw">)</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CPU:</span> 651ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Cool, that would explain it. Looking through <code>journalctl -xeu kube-controller-manager</code> I see <code>/var/lib/kubernetes/kube-controller-manager.kubeconfig: no such file or directory</code>. Let’s see where I was supposed to generate that and figure out what went wrong. Going back into my code I see I generated the file but didn’t copy it into <code>/var/lib/kubernetes</code> in my control plane playbook when I copied the rest of the configs in. Let’s try again.</p>
<p>Ok, after re-running the playbook with that file added the service is up and running.</p>
<p>Let’s try that command again.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl get serviceAccounts</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>      SECRETS   AGE</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ex">default</span>   1         43s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nice! Ok, back to the DNS and busybox stuff.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl get pods <span class="at">-l</span> k8s-app=kube-dns <span class="at">-n</span> kube-system</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>                       READY   STATUS              RESTARTS   AGE</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-2bz8x</span>   0/1     ContainerCreating   0          88s</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-pxw6f</span>   0/1     ContainerCreating   0          88s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Without re-running anything it looks like the controller manager has picked up what I ran before. Now I just have to wait a bit for it to create the container, I hope…</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl get pods <span class="at">-l</span> k8s-app=kube-dns <span class="at">-n</span> kube-system</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>                       READY   STATUS              RESTARTS   AGE</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-2bz8x</span>   0/1     ContainerCreating   0          60m</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-pxw6f</span>   0/1     ContainerCreating   0          60m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I took the dog for a walk and came back to this. There’s no way these containers should take an hour to create, so something else is broken. Time for more learning!</p>
<p>Running <code>kubectl describe pods -l k8s-app=kube-dns -n kube-system</code> I get so much information about what’s not working, neat! I think the relevant part is:</p>
<p><code>Warning  FailedCreatePodSandBox  58s (x369 over 86m)  kubelet  Failed to create pod sandbox: rpc error: code = Unknown desc = failed to create containerd task: cgroups: cgroup mountpoint does not exist: unknown</code></p>
<p>searching isn’t giving me a silver bullet solution to this, but it suggests there’s something wrong with my container runtime, so let’s take a look at my worker node.</p>
<p>First thing to do is check the status of the services I was supposed to start. <code>containerd</code>, <code>kubelet</code> and <code>kube-proxy</code> services all appear to be up and running. I can see the same error about cgroup mountpoint not existing in <code>journalctl -xeu containerd</code> so the problem is in there, but I’m still not sure what’s actually broken.</p>
<p>Ok, with a little more context that I should be searching for that error in association with containerd I find <a href="https://github.com/kubernetes/minikube/issues/11310">this issue</a>.</p>
<p>Now I have to figure out how to apply that to this guide. First let’s check if there are open issues in the repository to resolve it. There’s a <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/pull/728/commits/2adb5c0f5cae7e9d3129a4d8ab9f2ff8daf8ffaf#diff-387650bdd066d5645818d0579c5d3d562ceac2c9c94bd176a9e3162bc9917e94">PR</a> to upgrade to a newer kubernetes, that includes a different way of generating the containerd config file. I’m not sure how exactly to apply that in my example though.</p>
<p>I found a nice <a href="https://github.com/kubernetes/minikube/pull/11325/commits/813138734d347b3d84c527ed135fb37e509983f0">PR</a> in the minikube project that showed how to do the upgrade. After running it I got a little better, but was still having some resolution errors and backoffs. I’d noticed some other weird behaviour with my worker nodes so I decided to give them a reboot to see how that worked.</p>
<p>After a reboot here’s where I am:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl get pods <span class="at">-l</span> k8s-app=kube-dns <span class="at">-n</span> kube-system</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>                       READY   STATUS             RESTARTS   AGE</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-2bz8x</span>   0/1     ImagePullBackOff   0          3h30m</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-pxw6f</span>   0/1     ImagePullBackOff   0          3h30m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I ssh into a worker node and find that DNS no longer works on it. Controller nodes still resolve hosts fine, and if I put in the IP of a local or external site I can ping it. So something about how I configured that DNS service has broken things for my workers. Hmmmm. Even more fun, after a bit of this, DNS on my entire home network broke. I shut down all the nodes, rebooted my router and got DNS back.</p>
<p>After being afraid to touch this for a while I decided to start the nodes back up and see what happened. Right now DNS is ok on my host machine at least. Connecting into my worker nodes I can see that DNS doesn’t work on two of them, and a whole bunch of extra network interfaces have been created. That would definitely explain why I can’t pull images. I wonder if my earlier attempt to apply that manifest left something in a failed state that they can’t recover from. I give <code>kubectl delete -f coredns-1.8.yaml</code> a run to reverse the playbook. I can’t immediately resolve names on those nodes after running that, but let’s give them a reboot and see what happens. Ok, after a reboot DNS is back up. Let’s try applying that playbook again and see what happens:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> kubectl get pods <span class="at">-l</span> k8s-app=kube-dns <span class="at">-n</span> kube-system</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>                       READY   STATUS         RESTARTS   AGE</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-jn25z</span>   0/1     ErrImagePull   0          3s</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ex">coredns-8494f9c688-lhhg5</span>   0/1     ErrImagePull   0          3s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So we’re back to not working. At least the rest of my network is still ok for now. Looking at the workers that are coming back up, I think I see something confusing. The nodes that are running the coredns pods have a new network interface with an IP that matches my router: <code>cnio0:</code>. I can still ping my router by its IP, and I can still ping external sites if I know their IP, so routing isn’t completely broken, but name resolution seems to be. At this point I decided to confirm whether the weird network wide DNS failure I had previously was indeed a result of this configuration. I rebooted my phone and when it came back up DNS no longer worked. I deleted the manifest, rebooted my router, and all was right with the world again. I don’t even have my head around how this could happen, let alone what it means. I guess that <code>cnio0</code> device is broadcasting that it has my router’s IP or something?</p>
<p>Reading through <a href="https://github.com/ehlesp/smallab-k8s-pve-guide/blob/main/G017%20-%20Virtual%20Networking%20~%20Network%20configuration.md#g017-virtual-networking-network-configuration">this guide</a> a bit, which is more focused on a homelab k8s deployment I can see that they had two virtual network interfaces for the cluster, one for external facing connectivity, and one for internal facing cluster communication. I think probably trying to do everything on one network is part of what’s causing me problems.</p>
</section>
<section id="call-it-quits" class="level1">
<h1>Call it quits</h1>
<p>At this point I feel like I’m hitting pretty serious diminishing returns in terms of how much I’m learning vs how weird the edge cases I’m encountering are. I’m definitely not done learning kubernetes, and I might even come back to this later, but I think there are clearly some other aspects of my setup and kubernetes that I have to learn about more before working through this will provide additional value.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>